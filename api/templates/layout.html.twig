{% extends 'base.html.twig' %}

{% block body %}
<div data-controller="sidebar">
    {# Mobile sidebar overlay #}
    <div data-sidebar-target="overlay" class="hidden fixed inset-0 z-40 bg-gray-600 bg-opacity-75 transition-opacity lg:hidden"></div>

    {# Mobile sidebar #}
    <div data-sidebar-target="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 -translate-x-full transform transition-transform duration-300 ease-in-out lg:hidden">
        <div class="flex grow flex-col gap-y-5 overflow-y-auto bg-white px-6 pb-4 ring-1 ring-gray-900/10">
            <div class="flex h-16 shrink-0 items-center justify-between">
                <div class="flex items-center">
                    <span class="text-2xl">ðŸ“‹</span>
                    <span class="ml-2 text-xl font-bold text-gray-900">ZohoClone</span>
                </div>
                <button type="button" data-action="click->sidebar#close" class="-m-2.5 p-2.5 text-gray-700">
                    <span class="sr-only">Close sidebar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav class="flex flex-1 flex-col">
                <ul role="list" class="flex flex-1 flex-col gap-y-7">
                    <li>
                        <ul role="list" class="-mx-2 space-y-1">
                            <li>
                                <a href="{{ path('app_dashboard') }}" class="{{ app.request.get('_route') == 'app_dashboard' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                    </svg>
                                    Dashboard
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_project_index') }}" class="{{ app.request.get('_route') starts with 'app_project' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                                    </svg>
                                    Projects
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_task_my_tasks') }}" class="{{ app.request.get('_route') == 'app_task_my_tasks' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                    </svg>
                                    My Tasks
                                </a>
                            </li>
                        </ul>
                    </li>
                    {% if recent_projects is defined and recent_projects|length > 0 %}
                    <li>
                        <div class="text-xs font-semibold leading-6 text-gray-400">Recent Projects</div>
                        <ul role="list" class="-mx-2 mt-2 space-y-1">
                            {% for project in recent_projects %}
                            <li>
                                <a href="{{ path('app_project_show', {id: project.id}) }}" class="text-gray-700 hover:bg-gray-50 hover:text-primary-600 group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium text-gray-400">
                                        {{ project.name|slice(0, 1)|upper }}
                                    </span>
                                    <span class="truncate">{{ project.name }}</span>
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}
                    <li class="mt-auto">
                        <a href="{{ path('app_profile') }}" class="group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-700 hover:bg-gray-50 hover:text-primary-600">
                            <svg class="h-6 w-6 shrink-0 text-gray-400 group-hover:text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    {# Desktop sidebar #}
    {% include 'components/_sidebar.html.twig' %}

    <div class="lg:pl-72">
        {% include 'components/_header.html.twig' %}

        <main class="py-10">
            <div class="px-4 sm:px-6 lg:px-8">
                {% include 'components/_flash.html.twig' %}
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    {# Task Panel Off-Canvas (slides from right) #}
    <div id="task-panel-overlay" class="fixed inset-0 z-[60] bg-gray-600 bg-opacity-50 transition-opacity duration-300 opacity-0 pointer-events-none" onclick="closeTaskPanel()"></div>
    <div id="task-panel" class="fixed inset-y-0 right-0 z-[70] w-full max-w-xl transform translate-x-full transition-transform duration-300 ease-in-out bg-white shadow-xl">
        <div id="task-panel-content" class="h-full">
            {# Content loaded via AJAX #}
            <div class="flex items-center justify-center h-full">
                <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <script>
    function openTaskPanel(taskId) {
        const panel = document.getElementById('task-panel');
        const overlay = document.getElementById('task-panel-overlay');
        const content = document.getElementById('task-panel-content');

        // Show loading state
        content.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        `;

        // Show panel
        panel.classList.remove('translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');

        // Prevent body scroll
        document.body.style.overflow = 'hidden';

        // Fetch task details
        fetch(`/tasks/${taskId}/panel`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to load task');
            return response.text();
        })
        .then(html => {
            content.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading task:', error);
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-6">
                    <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                    </svg>
                    <p class="text-gray-900 font-medium">Failed to load task</p>
                    <p class="text-gray-500 text-sm mt-1">Please try again</p>
                    <button onclick="closeTaskPanel()" class="mt-4 text-sm text-primary-600 hover:text-primary-500">Close</button>
                </div>
            `;
        });
    }

    function closeTaskPanel() {
        const panel = document.getElementById('task-panel');
        const overlay = document.getElementById('task-panel-overlay');

        panel.classList.add('translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');

        // Restore body scroll
        document.body.style.overflow = '';
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const panel = document.getElementById('task-panel');
            if (panel && !panel.classList.contains('translate-x-full')) {
                closeTaskPanel();
            }
            // Also close any open dropdowns
            closeAllDropdowns();
        }
    });

    // ===== INLINE EDITING FUNCTIONS =====

    // Close all dropdowns
    function closeAllDropdowns() {
        document.querySelectorAll('.status-dropdown, .priority-dropdown, .milestone-dropdown, .add-assignee-dropdown').forEach(d => {
            d.classList.add('hidden');
        });
    }

    // Click outside to close dropdowns
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.status-badge-btn, .status-dropdown, .priority-badge-btn, .priority-dropdown, .milestone-btn, .milestone-dropdown, .add-assignee-btn, .add-assignee-dropdown')) {
            closeAllDropdowns();
        }
    });

    // Toggle Status Dropdown
    function toggleStatusDropdown(btn) {
        const dropdown = btn.parentElement.querySelector('.status-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Toggle Priority Dropdown
    function togglePriorityDropdown(btn) {
        const dropdown = btn.parentElement.querySelector('.priority-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Toggle Milestone Dropdown
    function toggleMilestoneDropdown(btn) {
        const dropdown = btn.parentElement.querySelector('.milestone-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Update Task Status
    async function updateTaskStatus(taskId, status, btn) {
        const statusLabels = {
            'todo': 'To Do',
            'in_progress': 'In Progress',
            'in_review': 'In Review',
            'completed': 'Completed'
        };
        const statusColors = {
            'todo': 'bg-gray-100 text-gray-700',
            'in_progress': 'bg-blue-100 text-blue-700',
            'in_review': 'bg-yellow-100 text-yellow-700',
            'completed': 'bg-green-100 text-green-700'
        };

        try {
            const response = await fetch(`/tasks/${taskId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ status: status })
            });

            if (!response.ok) throw new Error('Failed to update status');

            const data = await response.json();

            // Update the badge
            const badgeBtn = btn.closest('.status-dropdown').previousElementSibling;
            badgeBtn.querySelector('.status-label').textContent = statusLabels[status];
            badgeBtn.className = badgeBtn.className.replace(/bg-\w+-100 text-\w+-700/g, '');
            badgeBtn.classList.add(...statusColors[status].split(' '));

            closeAllDropdowns();
            Toastr.success('Status updated');
        } catch (error) {
            console.error('Error updating status:', error);
            Toastr.error('Failed to update status');
        }
    }

    // Update Task Priority
    async function updateTaskPriority(taskId, priority, btn) {
        const priorityLabels = {
            'none': 'None',
            'low': 'Low',
            'medium': 'Medium',
            'high': 'High'
        };
        const priorityColors = {
            'none': 'bg-gray-100 text-gray-700',
            'low': 'bg-blue-100 text-blue-700',
            'medium': 'bg-yellow-100 text-yellow-700',
            'high': 'bg-red-100 text-red-700'
        };

        try {
            const response = await fetch(`/tasks/${taskId}/priority`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ priority: priority })
            });

            if (!response.ok) throw new Error('Failed to update priority');

            // Update the badge
            const badgeBtn = btn.closest('.priority-dropdown').previousElementSibling;
            badgeBtn.querySelector('.priority-label').textContent = priorityLabels[priority];
            badgeBtn.className = badgeBtn.className.replace(/bg-\w+-100 text-\w+-700/g, '');
            badgeBtn.classList.add(...priorityColors[priority].split(' '));

            closeAllDropdowns();
            Toastr.success('Priority updated');
        } catch (error) {
            console.error('Error updating priority:', error);
            Toastr.error('Failed to update priority');
        }
    }

    // Update Task Milestone
    async function updateTaskMilestone(taskId, milestoneId, milestoneName, btn) {
        try {
            const response = await fetch(`/tasks/${taskId}/milestone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ milestone: milestoneId })
            });

            if (!response.ok) throw new Error('Failed to update milestone');

            // Update the label
            const milestoneBtn = btn.closest('.milestone-dropdown').previousElementSibling;
            milestoneBtn.querySelector('.milestone-label').textContent = milestoneName;

            closeAllDropdowns();
            Toastr.success('Milestone updated');
        } catch (error) {
            console.error('Error updating milestone:', error);
            Toastr.error('Failed to update milestone');
        }
    }

    // Update Start Date
    async function updateStartDate(input) {
        const endpoint = input.dataset.endpoint;
        const value = input.value;
        const originalValue = input.dataset.original || '';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ startDate: value || null })
            });

            const data = await response.json();

            if (!response.ok) {
                // Revert to original value
                input.value = originalValue;
                throw new Error(data.error || 'Failed to update start date');
            }

            // Update the original value
            input.dataset.original = value;

            // Remove placeholder if it exists
            const placeholder = input.parentElement.querySelector('.start-date-placeholder');
            if (placeholder && value) {
                placeholder.remove();
            }

            Toastr.success('Start date updated');
        } catch (error) {
            console.error('Error updating start date:', error);
            Toastr.error(error.message || 'Failed to update start date');
        }
    }

    // Update Due Date
    async function updateDueDate(input) {
        const endpoint = input.dataset.endpoint;
        const value = input.value;
        const originalValue = input.dataset.original || '';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ dueDate: value || null })
            });

            const data = await response.json();

            if (!response.ok) {
                // Revert to original value
                input.value = originalValue;
                throw new Error(data.error || 'Failed to update due date');
            }

            // Update the original value
            input.dataset.original = value;

            // Update styling for overdue
            if (data.isOverdue) {
                input.classList.add('text-red-600', 'font-medium');
                input.classList.remove('text-gray-900');
            } else {
                input.classList.remove('text-red-600', 'font-medium');
                input.classList.add('text-gray-900');
            }

            // Remove placeholder if it exists
            const placeholder = input.parentElement.querySelector('.due-date-placeholder');
            if (placeholder && value) {
                placeholder.remove();
            }

            Toastr.success('Due date updated');
        } catch (error) {
            console.error('Error updating due date:', error);
            Toastr.error(error.message || 'Failed to update due date');
        }
    }

    // Title editing - contenteditable
    document.addEventListener('blur', async function(e) {
        if (e.target.classList.contains('editable-title')) {
            const endpoint = e.target.dataset.endpoint;
            const original = e.target.dataset.original;
            const newValue = e.target.textContent.trim();

            if (newValue === original) return;
            if (!newValue) {
                e.target.textContent = original;
                Toastr.error('Title cannot be empty');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ title: newValue })
                });

                if (!response.ok) throw new Error('Failed to update title');

                e.target.dataset.original = newValue;
                Toastr.success('Title updated');
            } catch (error) {
                console.error('Error updating title:', error);
                e.target.textContent = original;
                Toastr.error('Failed to update title');
            }
        }
    }, true);

    // Prevent Enter from creating new line in title
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('editable-title') && e.key === 'Enter') {
            e.preventDefault();
            e.target.blur();
        }
        // Escape to cancel edit
        if (e.target.classList.contains('editable-title') && e.key === 'Escape') {
            e.target.textContent = e.target.dataset.original;
            e.target.blur();
        }
    });

    // Description editing
    function showDescriptionEditor(displayEl) {
        const container = displayEl.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const textarea = editor.querySelector('textarea');

        displayEl.classList.add('hidden');
        editor.classList.remove('hidden');
        textarea.focus();
    }

    function cancelDescriptionEdit(btn) {
        const container = btn.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const display = container.querySelector('.description-display');
        const textarea = editor.querySelector('textarea');

        textarea.value = textarea.dataset.original || '';
        editor.classList.add('hidden');
        display.classList.remove('hidden');
    }

    async function saveDescription(btn) {
        const container = btn.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const display = container.querySelector('.description-display');
        const textarea = editor.querySelector('textarea');
        const endpoint = textarea.dataset.endpoint;
        const newValue = textarea.value.trim();

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ description: newValue })
            });

            if (!response.ok) throw new Error('Failed to update description');

            textarea.dataset.original = newValue;

            if (newValue) {
                display.textContent = newValue;
                display.classList.remove('text-gray-400', 'italic');
                display.classList.add('text-gray-600');
            } else {
                display.textContent = display.dataset.placeholder;
                display.classList.add('text-gray-400', 'italic');
                display.classList.remove('text-gray-600');
            }

            editor.classList.add('hidden');
            display.classList.remove('hidden');
            Toastr.success('Description updated');
        } catch (error) {
            console.error('Error updating description:', error);
            Toastr.error('Failed to update description');
        }
    }

    // Assignee management
    async function removeAssignee(taskId, userId, btn) {
        try {
            const response = await fetch(`/tasks/${taskId}/assignees`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'remove', userId: userId })
            });

            if (!response.ok) throw new Error('Failed to remove assignee');

            // Remove the chip
            const chip = btn.closest('.assignee-chip');
            chip.remove();

            // Show "No assignees" if empty
            const container = document.querySelector('.assignees-container');
            const chips = container.querySelectorAll('.assignee-chip');
            if (chips.length === 0) {
                const noMsg = document.createElement('p');
                noMsg.className = 'no-assignees-msg text-sm text-gray-400 italic mt-2';
                noMsg.textContent = 'No assignees';
                container.parentElement.appendChild(noMsg);
            }

            Toastr.success('Assignee removed');
        } catch (error) {
            console.error('Error removing assignee:', error);
            Toastr.error('Failed to remove assignee');
        }
    }

    async function showAddAssigneeDropdown(btn) {
        const container = btn.closest('.assignees-container');
        const dropdown = container.querySelector('.add-assignee-dropdown');
        const projectId = container.dataset.projectId;
        const taskId = container.dataset.taskId;

        // Position the dropdown near the button
        const btnRect = btn.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        dropdown.style.left = (btnRect.left - containerRect.left) + 'px';

        closeAllDropdowns();
        dropdown.classList.remove('hidden');

        // Load project members
        try {
            const response = await fetch(`/projects/${projectId}/members`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('Failed to load members');

            const data = await response.json();
            const currentAssignees = Array.from(container.querySelectorAll('.assignee-chip'))
                .map(chip => chip.dataset.userId);

            // Filter out already assigned members
            const availableMembers = data.members.filter(m => !currentAssignees.includes(m.id));

            const dropdownContent = dropdown.querySelector('.py-1');
            if (availableMembers.length === 0) {
                dropdownContent.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No more members to add</div>';
            } else {
                dropdownContent.innerHTML = availableMembers.map(member => `
                    <button type="button"
                            onclick="addAssignee('${taskId}', '${member.id}', '${member.fullName}', '${member.initials}', this)"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                            <span class="text-xs font-medium text-primary-700">${member.initials}</span>
                        </span>
                        ${member.fullName}
                    </button>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading members:', error);
            dropdown.querySelector('.py-1').innerHTML = '<div class="px-4 py-2 text-sm text-red-500">Failed to load members</div>';
        }
    }

    async function addAssignee(taskId, userId, fullName, initials, btn) {
        try {
            const response = await fetch(`/tasks/${taskId}/assignees`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'add', userId: userId })
            });

            if (!response.ok) throw new Error('Failed to add assignee');

            // Add the new chip before the Add button
            const container = document.querySelector('.assignees-container');
            const addBtn = container.querySelector('.add-assignee-btn');

            const chip = document.createElement('span');
            chip.className = 'assignee-chip inline-flex items-center rounded-full bg-gray-100 py-1 pl-2 pr-1 text-sm font-medium text-gray-800';
            chip.dataset.userId = userId;
            chip.innerHTML = `
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                    <span class="text-xs font-medium text-primary-700">${initials}</span>
                </span>
                ${fullName}
                <button type="button"
                        onclick="removeAssignee('${taskId}', '${userId}', this)"
                        class="ml-1 inline-flex h-5 w-5 items-center justify-center rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;

            container.querySelector('.assignees-list').insertBefore(chip, addBtn);

            // Remove "No assignees" message
            const noMsg = container.parentElement.querySelector('.no-assignees-msg');
            if (noMsg) noMsg.remove();

            closeAllDropdowns();
            Toastr.success('Assignee added');
        } catch (error) {
            console.error('Error adding assignee:', error);
            Toastr.error('Failed to add assignee');
        }
    }

    // Comment handling
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('comment-textarea')) {
            const btn = e.target.closest('.add-comment-form').querySelector('.add-comment-btn');
            btn.disabled = !e.target.value.trim();
        }
    });

    async function addComment(taskId, btn) {
        const form = btn.closest('.add-comment-form');
        const textarea = form.querySelector('.comment-textarea');
        const content = textarea.value.trim();

        if (!content) return;

        btn.disabled = true;
        btn.textContent = 'Posting...';

        try {
            const response = await fetch(`/tasks/${taskId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ content: content })
            });

            if (!response.ok) throw new Error('Failed to add comment');

            const data = await response.json();

            // Add the new comment to the list
            const commentsList = document.querySelector('.comments-list');

            // Remove "No comments" message if present
            const noMsg = commentsList.querySelector('.no-comments-msg');
            if (noMsg) noMsg.remove();

            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item bg-gray-50 rounded-lg p-3';
            commentEl.dataset.commentId = data.comment.id;
            commentEl.innerHTML = `
                <div class="flex items-center mb-2">
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                        <span class="text-xs font-medium text-primary-700">${data.comment.authorInitials}</span>
                    </span>
                    <span class="text-sm font-medium text-gray-900">${data.comment.authorName}</span>
                    <span class="ml-auto text-xs text-gray-500">${data.comment.createdAt}</span>
                </div>
                <p class="text-sm text-gray-600 whitespace-pre-wrap">${escapeHtml(data.comment.content)}</p>
            `;

            // Insert at the beginning (newest first)
            commentsList.prepend(commentEl);

            // Update comment count
            const countSpan = document.querySelector('.comments-count');
            const currentCount = parseInt(countSpan.textContent.replace(/[()]/g, '') || '0');
            countSpan.textContent = `(${currentCount + 1})`;

            // Clear the form
            textarea.value = '';
            btn.textContent = 'Post Comment';
            btn.disabled = true;

            Toastr.success('Comment added');
        } catch (error) {
            console.error('Error adding comment:', error);
            btn.textContent = 'Post Comment';
            btn.disabled = false;
            Toastr.error('Failed to add comment');
        }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>
</div>
{% endblock %}

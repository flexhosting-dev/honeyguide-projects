{% extends 'layout.html.twig' %}

{% block title %}{{ project.name }} - Honeyguide Projects{% endblock %}

{% block content %}
<div class="space-y-6" data-turbo-cache="false">
    {# Header #}
    <div class="lg:flex lg:items-center lg:justify-between">
        <div class="min-w-0 flex-1">
            <nav class="flex" aria-label="Breadcrumb">
                <ol role="list" class="flex items-center space-x-4">
                    <li>
                        <a href="{{ path('app_project_index') }}" class="text-sm font-medium text-gray-500 hover:text-gray-700">Projects</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                            <span class="ml-4 text-sm font-medium text-gray-500">{{ project.name }}</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    {# Tabs #}
    <div id="project-tabs">
        {# Main Navigation Tabs - Order: Milestones, Tasks, Members, Feed #}
        <div class="flex items-center justify-between relative z-10">
            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-soft border border-gray-200/50 p-1.5 inline-flex space-x-1">
                {# Overview Tab - icon-only on small screens #}
                <button type="button" onclick="showTab(0)" id="tab-0"
                        title="Overview"
                        class="tab-btn inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg border-primary-500 text-primary-600 bg-primary-50 border">
                    <svg class="w-4 h-4 sm:mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
                    </svg>
                    <span class="hidden sm:inline">Overview</span>
                </button>
                {# Milestones Tab #}
                <button type="button" onclick="showTab(1)" id="tab-1"
                        title="Milestones"
                        class="tab-btn inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 border border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
                    </svg>
                    Milestones
                </button>
                {# Tasks Tab #}
                <button type="button" onclick="showTab(2)" id="tab-2"
                        title="Tasks"
                        class="tab-btn inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 border border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    Tasks
                </button>
                {# Members Tab - hidden on mobile, shown in "More" menu #}
                <button type="button" onclick="showTab(3)" id="tab-3"
                        title="Members"
                        class="tab-btn hidden md:inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 border border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                    </svg>
                    Members
                </button>
                {# Feed Tab - hidden on mobile, shown in "More" menu #}
                <button type="button" onclick="showTab(4)" id="tab-4"
                        title="Activity Feed"
                        class="tab-btn hidden md:inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 border border-transparent">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" />
                    </svg>
                    Feed
                </button>

                {# "More" dropdown - shown only on mobile #}
                <div class="relative md:hidden">
                    <button type="button" onclick="toggleMoreMenu()" id="more-menu-btn"
                            class="more-tab-btn inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-50 border border-transparent">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                        </svg>
                    </button>
                    <div id="more-menu-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 z-50 py-1">
                        <button type="button" onclick="showTabFromMore(3)"
                                class="more-menu-item w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" data-tab="3">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                            </svg>
                            Members
                        </button>
                        <button type="button" onclick="showTabFromMore(4)"
                                class="more-menu-item w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" data-tab="4">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" />
                            </svg>
                            Feed
                        </button>
                        <div class="border-t border-gray-100 my-1"></div>
                        {% if canEditProject %}
                        <a href="{{ path('app_project_edit', {id: project.id}) }}"
                           class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                            </svg>
                            Edit Project
                        </a>
                        {% endif %}
                        <button type="button"
                                onclick="toggleFavourite('{{ project.id }}', this)"
                                class="favourite-btn w-full flex items-center px-4 py-2 text-sm hover:bg-gray-50 transition-colors {{ is_favourite|default(false) ? 'text-yellow-500' : 'text-gray-700' }}"
                                data-project-id="{{ project.id }}"
                                data-is-favourite="{{ is_favourite|default(false) ? 'true' : 'false' }}">
                            <svg class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="{{ is_favourite|default(false) ? 'currentColor' : 'none' }}" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            {{ is_favourite|default(false) ? 'Unfavourite' : 'Favourite' }}
                        </button>
                    </div>
                </div>
            </div>

            {# Edit & Favourite - visible on desktop only, right-aligned #}
            <div class="hidden md:flex items-center space-x-1">
                <button type="button"
                        onclick="toggleFavourite('{{ project.id }}', this)"
                        class="favourite-btn inline-flex items-center px-3 py-2 rounded-lg transition-colors {{ is_favourite|default(false) ? 'text-yellow-500 hover:text-yellow-600' : 'text-gray-400 hover:text-yellow-500' }}"
                        title="{{ is_favourite|default(false) ? 'Remove from favourites' : 'Add to favourites' }}"
                        data-project-id="{{ project.id }}"
                        data-is-favourite="{{ is_favourite|default(false) ? 'true' : 'false' }}">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="{{ is_favourite|default(false) ? 'currentColor' : 'none' }}" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                {% if canEditProject %}
                <a href="{{ path('app_project_edit', {id: project.id}) }}"
                   title="Edit Project"
                   class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-gray-600 hover:bg-gray-100 border border-gray-200 bg-white shadow-sm transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                    </svg>
                    Edit
                </a>
                {% endif %}
            </div>
        </div>

        {# Overview Panel (First) #}
        <div id="panel-0" class="tab-panel pt-4">
            {% include 'project/_overview.html.twig' %}
        </div>

        {# Milestones Panel (Second) #}
        <div id="panel-1" class="tab-panel hidden pt-4">
            {% include 'milestone/_list.html.twig' with {project: project, milestones: project.milestones} %}
        </div>

        {# Tasks Panel (Third) #}
        <div id="panel-2" class="tab-panel hidden pt-4">
            {% include 'task/_task_page.html.twig' with {
                formAction: 'app_project_show',
                formActionParams: {id: project.id},
                tasks: tasks,
                tasksByStatus: tasksByStatus,
                tasksByPriority: tasksByPriority,
                tasksByMilestone: tasksByMilestone,
                milestones: milestones,
                kanbanModeKey: 'project_' ~ project.id ~ '_kanban_mode',
                filter: filter,
                userProjects: [],
                projectMembers: projectMembers,
                showProjectFilter: false,
                storageKey: 'project_' ~ project.id ~ '_view',
                showHeader: false,
                showAddButton: true,
                project: project,
                canEdit: canEditProject
            } %}
        </div>

        {# Members Panel (Fourth) #}
        <div id="panel-3" class="tab-panel hidden pt-4">
            {% include 'member/_list.html.twig' with {project: project, members: project.members, projectRoles: projectRoles} %}
        </div>

        {# Feed Panel (Fifth) - Lazy loaded #}
        <div id="panel-4" class="tab-panel hidden pt-4">
            <div class="bg-white/80 backdrop-blur-sm shadow-soft rounded-xl">
                <div class="px-4 py-5 sm:p-6">
                    {# Loading state #}
                    <div id="feed-loading" class="flex justify-center py-8">
                        <svg class="animate-spin h-8 w-8 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>

                    {# Feed content container #}
                    <div id="feed-content" class="hidden">
                        <div class="flow-root">
                            <ul id="feed-list" role="list">
                                {# Feed items loaded via JS #}
                            </ul>
                        </div>

                        {# Load more indicator #}
                        <div id="feed-load-more" class="hidden flex justify-center py-4 mt-4">
                            <svg class="animate-spin h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>

                        {# End of feed message #}
                        <div id="feed-end" class="hidden mt-6">
                            <div class="relative">
                                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                    <div class="w-full border-t border-gray-200"></div>
                                </div>
                                <div class="relative flex justify-center">
                                    <span class="bg-white px-3 flex items-center gap-2 text-sm text-gray-400">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                        </svg>
                                        You're all caught up
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Empty state #}
                    <div id="feed-empty" class="hidden">
                        {% include 'components/_empty_state.html.twig' with {
                            icon: 'comment',
                            title: 'No activity yet',
                            description: 'Feed will appear here as team members work on this project.'
                        } %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.PROJECT_ID = '{{ project.id }}';
window.STORAGE_KEY_TAB = `project_${PROJECT_ID}_tab`;
// Note: view toggle is handled by _task_page.html.twig with its own storage key
window.STORAGE_KEY_LAST_PROJECT = 'workflow_last_project';

// Feed lazy loading state
window.feedState = {
    loaded: false,
    loading: false,
    page: 1,
    hasMore: true
};

function showTab(index, save = true) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        if (i === index) {
            btn.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            btn.classList.add('border-primary-500', 'text-primary-600', 'bg-primary-50', 'border');
        } else {
            btn.classList.remove('border-primary-500', 'text-primary-600', 'bg-primary-50', 'border');
            btn.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
        }
    });

    // Update "More" button styling (highlight if a hidden tab is active)
    const moreBtn = document.querySelector('.more-tab-btn');
    if (moreBtn) {
        const isMoreTabActive = index >= 3; // Members (3) and Feed (4) are in "More" menu on mobile
        if (isMoreTabActive) {
            moreBtn.classList.remove('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
            moreBtn.classList.add('border-primary-500', 'text-primary-600', 'bg-primary-50', 'border');
        } else {
            moreBtn.classList.remove('border-primary-500', 'text-primary-600', 'bg-primary-50', 'border');
            moreBtn.classList.add('text-gray-600', 'hover:bg-gray-50', 'border-transparent');
        }
    }

    // Update "More" menu items
    document.querySelectorAll('.more-menu-item').forEach(item => {
        const tabIndex = parseInt(item.dataset.tab);
        if (tabIndex === index) {
            item.classList.add('bg-primary-50', 'text-primary-600');
            item.classList.remove('text-gray-700');
        } else {
            item.classList.remove('bg-primary-50', 'text-primary-600');
            item.classList.add('text-gray-700');
        }
    });

    // Update panels
    document.querySelectorAll('.tab-panel').forEach((panel, i) => {
        if (i === index) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
    });

    // Save to localStorage
    if (save) {
        localStorage.setItem(STORAGE_KEY_TAB, index);
    }

    // Mount Vue components when Tasks tab is shown (panel may have been hidden)
    if (index === 2 && typeof window.mountVueComponents === 'function') {
        setTimeout(function() { window.mountVueComponents(); }, 0);
    }

    // Reload feed every time Feed tab is opened
    if (index === 4 && !feedState.loading) {
        reloadFeed();
    }
}

function toggleMoreMenu() {
    const dropdown = document.getElementById('more-menu-dropdown');
    dropdown.classList.toggle('hidden');
}

function showTabFromMore(index) {
    showTab(index);
    document.getElementById('more-menu-dropdown').classList.add('hidden');
}

// Close "More" menu when clicking outside
document.addEventListener('click', function(e) {
    const moreBtn = document.getElementById('more-menu-btn');
    const dropdown = document.getElementById('more-menu-dropdown');
    if (moreBtn && dropdown && !moreBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});

// Reset feed state and reload from scratch
function reloadFeed() {
    feedState.loaded = false;
    feedState.loading = false;
    feedState.page = 1;
    feedState.hasMore = true;

    const listEl = document.getElementById('feed-list');
    const contentEl = document.getElementById('feed-content');
    const emptyEl = document.getElementById('feed-empty');
    const endEl = document.getElementById('feed-end');
    const loadingEl = document.getElementById('feed-loading');

    if (listEl) listEl.innerHTML = '';
    if (contentEl) contentEl.classList.add('hidden');
    if (emptyEl) emptyEl.classList.add('hidden');
    if (endEl) endEl.classList.add('hidden');
    if (loadingEl) loadingEl.classList.remove('hidden');

    loadFeed();
}

// Feed lazy loading and infinite scroll
async function loadFeed(append = false) {
    if (feedState.loading || (!append && feedState.loaded) || (append && !feedState.hasMore)) {
        return;
    }

    feedState.loading = true;

    const loadingEl = document.getElementById('feed-loading');
    const loadMoreEl = document.getElementById('feed-load-more');
    const contentEl = document.getElementById('feed-content');
    const emptyEl = document.getElementById('feed-empty');
    const listEl = document.getElementById('feed-list');
    const endEl = document.getElementById('feed-end');

    if (append) {
        loadMoreEl.classList.remove('hidden');
    }

    try {
        const response = await fetch(`${BASE_PATH}/projects/${PROJECT_ID}/feed?page=${feedState.page}&limit=20`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!response.ok) throw new Error('Failed to load feed');

        const data = await response.json();

        if (!append) {
            loadingEl.classList.add('hidden');

            if (data.activities.length === 0) {
                emptyEl.classList.remove('hidden');
                feedState.loaded = true;
                feedState.loading = false;
                return;
            }

            contentEl.classList.remove('hidden');
        }

        // Render activities
        data.activities.forEach((activity, index) => {
            const isLast = !data.hasMore && index === data.activities.length - 1;
            const li = document.createElement('li');
            const avatarHtml = activity.user.avatar
                ? `<img src="${activity.user.avatar}" alt="${activity.user.name}" class="w-full h-full object-cover rounded-full">`
                : `<span class="w-full h-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center rounded-full"><span class="text-xs font-medium text-white">${activity.user.initials}</span></span>`;
            li.innerHTML = `
                <div class="relative ${isLast ? 'pb-2' : 'pb-8'}">
                    ${!isLast ? '<span class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-gradient-to-b from-green-200 to-blue-200" aria-hidden="true"></span>' : ''}
                    <div class="relative flex space-x-3">
                        <div>
                            <span class="h-8 w-8 rounded-full overflow-hidden flex items-center justify-center ring-4 ring-white">
                                ${avatarHtml}
                            </span>
                        </div>
                        <div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
                            <div>
                                <p class="text-sm text-gray-600">${activity.description}</p>
                            </div>
                            <div class="whitespace-nowrap text-right text-xs text-gray-400">
                                <time>${activity.createdAt}</time>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            listEl.appendChild(li);
        });

        feedState.hasMore = data.hasMore;
        feedState.page++;
        feedState.loaded = true;

        if (!data.hasMore) {
            endEl.classList.remove('hidden');
        }

    } catch (error) {
        console.error('Error loading feed:', error);
        if (!append) {
            loadingEl.innerHTML = '<p class="text-red-500">Failed to load feed</p>';
        }
    } finally {
        feedState.loading = false;
        loadMoreEl.classList.add('hidden');
    }
}

// Infinite scroll for feed
function setupFeedScroll() {
    const panel = document.getElementById('panel-4');
    const contentEl = document.getElementById('feed-content');

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && feedState.loaded && feedState.hasMore && !feedState.loading) {
                loadFeed(true);
            }
        });
    }, { rootMargin: '100px' });

    const loadMoreEl = document.getElementById('feed-load-more');
    if (loadMoreEl) {
        observer.observe(loadMoreEl);
    }
}

// Restore state on page load â€” runs immediately since script is at bottom of body
(function initProjectPage() {
    // Save this as last visited project
    localStorage.setItem(STORAGE_KEY_LAST_PROJECT, PROJECT_ID);

    // Restore tab
    const savedTab = localStorage.getItem(STORAGE_KEY_TAB);
    if (savedTab !== null) {
        showTab(parseInt(savedTab), false);
    }

    // Setup feed infinite scroll
    setupFeedScroll();
})();

// Also handle Turbo navigation (re-entering this page via back/forward)
document.addEventListener('turbo:load', function() {
    const savedTab = localStorage.getItem(STORAGE_KEY_TAB);
    if (savedTab !== null) {
        showTab(parseInt(savedTab), false);
    }
});
</script>
{% endblock %}

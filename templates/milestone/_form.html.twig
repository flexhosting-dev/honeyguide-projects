{# Milestone Form Partial #}
{{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}

<div>
    {{ form_label(form.name, null, {'label_attr': {'class': 'block text-sm font-medium leading-6 text-gray-900'}}) }}
    <div class="mt-2">
        {{ form_widget(form.name) }}
    </div>
    {{ form_errors(form.name) }}
</div>

<div>
    {{ form_label(form.description, null, {'label_attr': {'class': 'block text-sm font-medium leading-6 text-gray-900'}}) }}
    <div class="mt-2">
        {# Hidden field for form submission #}
        {{ form_widget(form.description, {'attr': {'style': 'display:none'}}) }}
        {# Rich text editor that syncs to the hidden field #}
        <div
            data-vue-component="RichTextEditor"
            data-vue-form-field-id="{{ form.description.vars.id }}"
            data-vue-initial-content="{{ form.description.vars.value|default('')|e('html_attr') }}"
            data-vue-can-edit="true"
            data-vue-show-attachments="false"
        >
            <div class="border border-gray-300 rounded-lg p-3 min-h-[120px] text-sm text-gray-500">
                Loading editor...
            </div>
        </div>
    </div>
    {{ form_errors(form.description) }}
</div>

<div class="grid grid-cols-2 gap-4">
    <div>
        {{ form_label(form.status, null, {'label_attr': {'class': 'block text-sm font-medium leading-6 text-gray-900'}}) }}
        <div class="mt-2">
            {{ form_widget(form.status) }}
        </div>
        {{ form_errors(form.status) }}
    </div>

    <div>
        {{ form_label(form.dueDate, null, {'label_attr': {'class': 'block text-sm font-medium leading-6 text-gray-900'}}) }}
        <div class="mt-2">
            {{ form_widget(form.dueDate) }}
        </div>
        {{ form_errors(form.dueDate) }}
    </div>
</div>

{# Targets Section #}
{% if milestone is defined and milestone.id is defined %}
<div>
    <label class="block text-sm font-medium leading-6 text-gray-900">Deliverables</label>
    <div class="mt-2 space-y-2" id="targets-list">
        {% if milestone.targets is defined %}
            {% for target in milestone.targets %}
                <div class="flex items-center gap-2 target-row">
                    <input type="checkbox" {% if target.completed %}checked{% endif %}
                           class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600"
                           data-target-id="{{ target.id }}"
                           data-toggle-url="{{ path('app_milestone_target_toggle', {projectId: project.id, id: milestone.id, targetId: target.id}) }}"
                           onchange="fetch(this.dataset.toggleUrl, {method:'POST',headers:{'X-Requested-With':'XMLHttpRequest'}}).then(()=>{})">
                    <span class="text-sm text-gray-700 flex-1 {{ target.completed ? 'line-through text-gray-400' : '' }}">{{ target.description }}</span>
                    <button type="button"
                            class="text-gray-400 hover:text-red-500"
                            onclick="(async()=>{if(await showConfirmDialog({title:'Remove Target',message:'Are you sure you want to remove this target?',confirmText:'Remove',type:'danger'}))fetch('{{ path('app_milestone_target_remove', {projectId: project.id, id: milestone.id, targetId: target.id}) }}',{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest'}}).then(()=>this.closest('.target-row').remove())})()">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
    </div>
    <div class="mt-3 flex gap-2">
        <input type="text" id="new-target-input" placeholder="Add a new target..."
               class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
        <button type="button" id="add-target-btn"
                class="inline-flex items-center rounded-md bg-primary-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 whitespace-nowrap"
                data-add-url="{{ path('app_milestone_target_add', {projectId: project.id, id: milestone.id}) }}">
            Add
        </button>
    </div>
    <script>
        document.getElementById('add-target-btn')?.addEventListener('click', function() {
            const input = document.getElementById('new-target-input');
            const desc = input.value.trim();
            if (!desc) return;
            fetch(this.dataset.addUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
                body: JSON.stringify({description: desc})
            }).then(r => r.json()).then(() => { location.reload(); });
            input.value = '';
        });
        document.getElementById('new-target-input')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('add-target-btn').click(); }
        });
    </script>
</div>
{% endif %}

<div class="flex justify-end gap-3 pt-4">
    <a href="{{ app.request.headers.get('referer') ?: path('app_project_show', {id: project.id}) }}"
       class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
        Cancel
    </a>
    <button type="submit"
            class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
        {{ button_text }}
    </button>
</div>

{{ form_end(form) }}

{% extends 'base.html.twig' %}

{% block body %}
{% set theme = app.user.uiTheme|default('gradient') %}
<div data-controller="sidebar">
    {# Mobile sidebar overlay #}
    <div data-sidebar-target="overlay" class="hidden fixed inset-0 z-40 bg-gray-600 bg-opacity-75 transition-opacity lg:hidden"></div>

    {# Mobile sidebar #}
    <div data-sidebar-target="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 -translate-x-full transform transition-transform duration-300 ease-in-out lg:hidden">
        {% if theme == 'gradient' %}
        {# Gradient Theme Mobile Sidebar #}
        <div class="flex h-full grow flex-col gap-y-5 overflow-y-auto sidebar-scroll bg-gradient-to-b from-primary-600 via-primary-700 to-indigo-800 px-6 pb-4 relative">
            {# Decorative background elements #}
            <div class="absolute inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-white/5 rounded-full blur-3xl"></div>
                <div class="absolute top-1/3 -left-10 w-40 h-40 bg-indigo-400/10 rounded-full blur-2xl"></div>
                <div class="absolute bottom-1/4 right-0 w-32 h-32 bg-primary-300/10 rounded-full blur-xl"></div>
                <div class="absolute -bottom-10 left-1/4 w-48 h-48 bg-white/5 rounded-full blur-3xl"></div>
            </div>

            <div class="relative flex h-16 shrink-0 items-center justify-between">
                <div class="flex items-center">
                    <span class="text-2xl">ðŸŽ¯</span>
                    <span class="ml-2 text-xl font-bold text-white drop-shadow-sm">Honeyguide Projects</span>
                </div>
                <button type="button" data-action="click->sidebar#close" class="-m-2.5 p-2.5 text-white/80 hover:text-white transition-colors">
                    <span class="sr-only">Close sidebar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav class="relative flex flex-1 flex-col">
                <ul role="list" class="flex flex-1 flex-col gap-y-7">
                    <li>
                        <ul role="list" class="-mx-2 space-y-1">
                            <li>
                                <a href="{{ path('app_dashboard') }}" class="{{ app.request.get('_route') == 'app_dashboard' ? 'bg-white/20 text-white' : 'text-white/80 hover:bg-white/10 hover:text-white' }} group flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                    <svg class="h-6 w-6 shrink-0 {{ app.request.get('_route') == 'app_dashboard' ? 'text-white' : 'text-white/70 group-hover:text-white' }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                    </svg>
                                    Dashboard
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_project_index') }}" class="{{ app.request.get('_route') starts with 'app_project' ? 'bg-white/20 text-white' : 'text-white/80 hover:bg-white/10 hover:text-white' }} group flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                    <svg class="h-6 w-6 shrink-0 {{ app.request.get('_route') starts with 'app_project' ? 'text-white' : 'text-white/70 group-hover:text-white' }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                                    </svg>
                                    Projects
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_task_my_tasks') }}" class="{{ app.request.get('_route') == 'app_task_my_tasks' ? 'bg-white/20 text-white' : 'text-white/80 hover:bg-white/10 hover:text-white' }} group flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                    <svg class="h-6 w-6 shrink-0 {{ app.request.get('_route') == 'app_task_my_tasks' ? 'text-white' : 'text-white/70 group-hover:text-white' }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                    </svg>
                                    My Tasks
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_task_all_tasks') }}" class="{{ app.request.get('_route') == 'app_task_all_tasks' ? 'bg-white/20 text-white' : 'text-white/80 hover:bg-white/10 hover:text-white' }} group flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                    <svg class="h-6 w-6 shrink-0 {{ app.request.get('_route') == 'app_task_all_tasks' ? 'text-white' : 'text-white/70 group-hover:text-white' }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                    </svg>
                                    All Tasks
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li id="favourite-projects-section-mobile" class="{{ favourite_projects is not defined or favourite_projects|length == 0 ? 'hidden' : '' }}">
                        <div class="text-xs font-semibold leading-6 text-white/50 uppercase tracking-wider flex items-center gap-1">
                            <svg class="h-3 w-3 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Favourites
                        </div>
                        <ul role="list" class="-mx-2 mt-2 space-y-1" id="favourite-projects-list-mobile">
                            {% for project in favourite_projects|default([]) %}
                            <li class="favourite-project-item group/item overflow-hidden{{ loop.index > 3 ? ' fav-overflow hidden' : '' }}" data-project-id="{{ project.id }}" data-project-name="{{ project.name }}">
                                <div class="flex items-center gap-x-1 min-w-0">
                                    <a href="{{ path('app_project_show', {id: project.id}) }}" class="text-white/80 hover:bg-white/10 hover:text-white flex-1 min-w-0 flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg bg-yellow-500/20 text-[0.625rem] font-medium text-yellow-300 group-hover/item:bg-yellow-500/30">
                                            {{ project.name|slice(0, 1)|upper }}
                                        </span>
                                        <span class="truncate">{{ project.name }}</span>
                                    </a>
                                    <button type="button"
                                            onclick="removeFavourite('{{ project.id }}', this)"
                                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-white/50 hover:text-white hover:bg-white/10 transition-all"
                                            title="Remove from favourites">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% if favourite_projects|default([])|length > 3 %}
                        <button type="button" onclick="toggleFavOverflow(this)" class="fav-show-more -mx-2 mt-1 w-full text-left px-2.5 py-1.5 text-xs font-medium text-white/50 hover:text-white/80 transition-colors" data-list-id="favourite-projects-list-mobile">
                            <span class="fav-more-text">{{ favourite_projects|length - 3 }} more</span>
                        </button>
                        {% endif %}
                    </li>
                    {% if recent_projects is defined and recent_projects|length > 0 %}
                    <li>
                        <div class="text-xs font-semibold leading-6 text-white/50 uppercase tracking-wider">Recent Projects</div>
                        <ul role="list" class="-mx-2 mt-2 space-y-1" id="recent-projects-list-mobile">
                            {% for project in recent_projects %}
                            <li class="recent-project-item group/item overflow-hidden" data-project-id="{{ project.id }}">
                                <div class="flex items-center gap-x-1 min-w-0">
                                    <a href="{{ path('app_project_show', {id: project.id}) }}" class="text-white/80 hover:bg-white/10 hover:text-white flex-1 min-w-0 flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg bg-white/20 text-[0.625rem] font-medium text-white group-hover/item:bg-white/30">
                                            {{ project.name|slice(0, 1)|upper }}
                                        </span>
                                        <span class="truncate">{{ project.name }}</span>
                                    </a>
                                    <button type="button"
                                            onclick="hideRecentProject('{{ project.id }}', this)"
                                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-white/50 hover:text-white hover:bg-white/10 transition-all"
                                            title="Remove from recent">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}

                    <li class="mt-auto">
                        <a href="{{ path('app_settings') }}" class="{{ app.request.get('_route') starts with 'app_settings' or app.request.get('_route') starts with 'app_profile' or app.request.get('_route') starts with 'app_admin' ? 'bg-white/20 text-white' : 'text-white/80 hover:bg-white/10 hover:text-white' }} group -mx-2 flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                            <svg class="h-6 w-6 shrink-0 {{ app.request.get('_route') starts with 'app_settings' or app.request.get('_route') starts with 'app_profile' or app.request.get('_route') starts with 'app_admin' ? 'text-white' : 'text-white/70 group-hover:text-white' }}" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% else %}
        {# Classic White Theme Mobile Sidebar #}
        <div class="flex h-full grow flex-col gap-y-5 overflow-y-auto sidebar-scroll border-r border-gray-200 bg-white px-6 pb-4">
            <div class="flex h-16 shrink-0 items-center justify-between">
                <div class="flex items-center">
                    <span class="text-2xl">ðŸŽ¯</span>
                    <span class="ml-2 text-xl font-bold text-gray-900">Honeyguide Projects</span>
                </div>
                <button type="button" data-action="click->sidebar#close" class="-m-2.5 p-2.5 text-gray-700">
                    <span class="sr-only">Close sidebar</span>
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav class="flex flex-1 flex-col">
                <ul role="list" class="flex flex-1 flex-col gap-y-7">
                    <li>
                        <ul role="list" class="-mx-2 space-y-1">
                            <li>
                                <a href="{{ path('app_dashboard') }}" class="{{ app.request.get('_route') == 'app_dashboard' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                    </svg>
                                    Dashboard
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_project_index') }}" class="{{ app.request.get('_route') starts with 'app_project' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                                    </svg>
                                    Projects
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_task_my_tasks') }}" class="{{ app.request.get('_route') == 'app_task_my_tasks' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                    </svg>
                                    My Tasks
                                </a>
                            </li>
                            <li>
                                <a href="{{ path('app_task_all_tasks') }}" class="{{ app.request.get('_route') == 'app_task_all_tasks' ? 'bg-gray-50 text-primary-600' : 'text-gray-700 hover:bg-gray-50 hover:text-primary-600' }} group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                    <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                    </svg>
                                    All Tasks
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li id="favourite-projects-section-mobile-classic" class="{{ favourite_projects is not defined or favourite_projects|length == 0 ? 'hidden' : '' }}">
                        <div class="text-xs font-semibold leading-6 text-gray-400 flex items-center gap-1">
                            <svg class="h-3 w-3 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Favourites
                        </div>
                        <ul role="list" class="-mx-2 mt-2 space-y-1" id="favourite-projects-list-mobile-classic">
                            {% for project in favourite_projects|default([]) %}
                            <li class="favourite-project-item group/item overflow-hidden{{ loop.index > 3 ? ' fav-overflow hidden' : '' }}" data-project-id="{{ project.id }}" data-project-name="{{ project.name }}">
                                <div class="flex items-center gap-x-1 min-w-0">
                                    <a href="{{ path('app_project_show', {id: project.id}) }}" class="text-gray-700 hover:bg-yellow-50 hover:text-yellow-700 flex-1 min-w-0 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border border-yellow-300 bg-yellow-50 text-[0.625rem] font-medium text-yellow-600 group-hover/item:border-yellow-400 group-hover/item:bg-yellow-100">
                                            {{ project.name|slice(0, 1)|upper }}
                                        </span>
                                        <span class="truncate">{{ project.name }}</span>
                                    </a>
                                    <button type="button"
                                            onclick="removeFavourite('{{ project.id }}', this)"
                                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-all"
                                            title="Remove from favourites">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% if favourite_projects|default([])|length > 3 %}
                        <button type="button" onclick="toggleFavOverflow(this)" class="fav-show-more -mx-2 mt-1 w-full text-left px-2.5 py-1.5 text-xs font-medium text-gray-400 hover:text-gray-600 transition-colors" data-list-id="favourite-projects-list-mobile-classic">
                            <span class="fav-more-text">{{ favourite_projects|length - 3 }} more</span>
                        </button>
                        {% endif %}
                    </li>
                    {% if recent_projects is defined and recent_projects|length > 0 %}
                    <li>
                        <div class="text-xs font-semibold leading-6 text-gray-400">Recent Projects</div>
                        <ul role="list" class="-mx-2 mt-2 space-y-1" id="recent-projects-list-mobile-classic">
                            {% for project in recent_projects %}
                            <li class="recent-project-item group/item overflow-hidden" data-project-id="{{ project.id }}">
                                <div class="flex items-center gap-x-1 min-w-0">
                                    <a href="{{ path('app_project_show', {id: project.id}) }}" class="text-gray-700 hover:bg-gray-50 hover:text-primary-600 flex-1 min-w-0 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border border-gray-200 bg-white text-[0.625rem] font-medium text-gray-400 group-hover/item:border-primary-600 group-hover/item:text-primary-600">
                                            {{ project.name|slice(0, 1)|upper }}
                                        </span>
                                        <span class="truncate">{{ project.name }}</span>
                                    </a>
                                    <button type="button"
                                            onclick="hideRecentProject('{{ project.id }}', this)"
                                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-all"
                                            title="Remove from recent">
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endif %}

                    <li class="mt-auto">
                        <a href="{{ path('app_settings') }}" class="group -mx-2 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-700 hover:bg-gray-50 hover:text-primary-600">
                            <svg class="h-6 w-6 shrink-0 text-gray-400 group-hover:text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    {# Desktop sidebar #}
    {% include 'components/_sidebar.html.twig' %}

    <div class="lg:pl-72">
        {% include 'components/_header.html.twig' %}

        <main class="py-10">
            <div class="px-4 sm:px-6 lg:px-8">
                {% include 'components/_flash.html.twig' %}
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    {# Task Panel Off-Canvas (slides from right) â€” supports stacked subtask panels #}
    <div id="task-panel-overlay" class="fixed inset-0 z-[60] bg-gray-600 bg-opacity-50 transition-opacity duration-300 opacity-0 pointer-events-none" onclick="closeTaskPanel()"></div>
    <div id="task-panel" class="fixed inset-y-0 right-0 z-[70] w-full max-w-xl transform translate-x-full transition-transform duration-300 ease-in-out bg-white shadow-xl overflow-hidden">
        <div id="task-panel-stack" class="relative h-full">
            <div id="task-panel-content" class="h-full panel-layer" data-task-id="">
                {# Content loaded via AJAX #}
                <div class="flex items-center justify-center h-full">
                    <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    {# Recurrence Modal #}
    <div id="recurrence-modal" class="fixed inset-0 z-[100] hidden">
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50" onclick="closeRecurrenceModal()"></div>
        <div class="fixed inset-0 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Set Recurrence</h3>
                                <div class="mt-4 space-y-4">
                                    {# Frequency #}
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Repeat</label>
                                        <select id="recurrence-frequency" onchange="updateRecurrenceOptions()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                            <option value="">Does not repeat</option>
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                    </div>

                                    {# Interval #}
                                    <div id="recurrence-interval-container" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Every</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="recurrence-interval" value="1" min="1" max="12" class="w-20 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                            <span id="recurrence-interval-label" class="text-sm text-gray-600">days</span>
                                        </div>
                                    </div>

                                    {# Weekdays Only (for daily) #}
                                    <div id="recurrence-weekdays-container" class="hidden">
                                        <label class="flex items-center gap-2">
                                            <input type="checkbox" id="recurrence-weekdays-only" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                            <span class="text-sm text-gray-700">Weekdays only (Mon-Fri)</span>
                                        </label>
                                    </div>

                                    {# Week Days (for weekly) #}
                                    <div id="recurrence-weekdays-select" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">On days</label>
                                        <div class="flex gap-1.5 flex-wrap">
                                            <label class="weekday-btn"><input type="checkbox" value="1" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Mon</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="2" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Tue</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="3" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Wed</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="4" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Thu</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="5" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Fri</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="6" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Sat</span></label>
                                            <label class="weekday-btn"><input type="checkbox" value="7" class="hidden"><span class="px-3 py-1.5 text-sm rounded-md border cursor-pointer hover:bg-gray-50">Sun</span></label>
                                        </div>
                                    </div>

                                    {# Monthly Type (for monthly) #}
                                    <div id="recurrence-monthly-container" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Repeat on</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center gap-2">
                                                <input type="radio" name="monthly-type" value="dayOfMonth" checked class="text-primary-600 focus:ring-primary-500">
                                                <span class="text-sm text-gray-700">Same day of month</span>
                                            </label>
                                            <label class="flex items-center gap-2">
                                                <input type="radio" name="monthly-type" value="dayOfWeek" class="text-primary-600 focus:ring-primary-500">
                                                <span class="text-sm text-gray-700">Same day of week</span>
                                            </label>
                                        </div>
                                        <div id="monthly-dow-options" class="hidden mt-3 pl-6 space-y-2">
                                            <select id="monthly-week-of-month" class="rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                                <option value="1">First</option>
                                                <option value="2">Second</option>
                                                <option value="3">Third</option>
                                                <option value="4">Fourth</option>
                                                <option value="-1">Last</option>
                                            </select>
                                            <select id="monthly-day-of-week" class="rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                                <option value="1">Monday</option>
                                                <option value="2">Tuesday</option>
                                                <option value="3">Wednesday</option>
                                                <option value="4">Thursday</option>
                                                <option value="5">Friday</option>
                                                <option value="6">Saturday</option>
                                                <option value="7">Sunday</option>
                                            </select>
                                        </div>
                                    </div>

                                    {# End Conditions #}
                                    <div id="recurrence-end-container" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ends</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center gap-2">
                                                <input type="radio" name="end-type" value="never" checked class="text-primary-600 focus:ring-primary-500">
                                                <span class="text-sm text-gray-700">End of year</span>
                                            </label>
                                            <label class="flex items-center gap-2">
                                                <input type="radio" name="end-type" value="date" class="text-primary-600 focus:ring-primary-500">
                                                <span class="text-sm text-gray-700">On date</span>
                                                <input type="date" id="recurrence-end-date" class="ml-2 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" disabled>
                                            </label>
                                            <label class="flex items-center gap-2">
                                                <input type="radio" name="end-type" value="count" class="text-primary-600 focus:ring-primary-500">
                                                <span class="text-sm text-gray-700">After</span>
                                                <input type="number" id="recurrence-count" value="10" min="1" max="52" class="ml-2 w-16 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm" disabled>
                                                <span class="text-sm text-gray-700">occurrences</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                        <button type="button" onclick="saveRecurrence()" class="inline-flex w-full justify-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 sm:ml-3 sm:w-auto">Save</button>
                        <button type="button" onclick="closeRecurrenceModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                        <button type="button" id="remove-recurrence-btn" onclick="removeRecurrence()" class="hidden mt-3 sm:mt-0 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-red-600 shadow-sm ring-1 ring-inset ring-red-300 hover:bg-red-50 sm:w-auto sm:mr-auto">Remove</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Subtask Completion Warning Modal #}
    <div id="subtask-completion-modal" class="fixed inset-0 z-[100] hidden">
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50" onclick="closeSubtaskCompletionModal()"></div>
        <div class="fixed inset-0 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-yellow-100 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                <h3 class="text-base font-semibold leading-6 text-gray-900">Open Subtasks</h3>
                                <div class="mt-2">
                                    <p class="text-sm text-gray-500" id="subtask-completion-message">
                                        This task has open subtasks. How would you like to proceed?
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 flex flex-col sm:flex-row-reverse gap-2 sm:px-6">
                        <button type="button" onclick="confirmCompleteWithSubtasks()" class="inline-flex w-full justify-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 sm:w-auto">
                            Complete All
                        </button>
                        <button type="button" onclick="confirmCompleteParentOnly()" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto">
                            Complete Anyway
                        </button>
                        <button type="button" onclick="closeSubtaskCompletionModal()" class="inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-500 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto sm:mr-auto">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Task Picker Modal for selecting new parent #}
    <div id="task-picker-modal" class="fixed inset-0 z-[100] hidden">
        <div class="fixed inset-0 bg-gray-600 bg-opacity-50" onclick="closeTaskPickerModal()"></div>
        <div class="fixed inset-0 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Select New Parent Task</h3>
                            <button type="button" onclick="closeTaskPickerModal()" class="text-gray-400 hover:text-gray-500">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4">
                            <input type="text"
                                   id="task-picker-search"
                                   oninput="filterTaskPickerList()"
                                   placeholder="Search tasks..."
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                        </div>
                        <div id="task-picker-list" class="max-h-80 overflow-y-auto border border-gray-200 rounded-md" data-tasks="[]">
                            <div class="px-4 py-8 text-center text-gray-500">Loading...</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 flex justify-end sm:px-6">
                        <button type="button" onclick="closeTaskPickerModal()" class="inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    .weekday-btn input:checked + span {
        background-color: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }
    </style>

    <script>
    // Base path for all API calls (handles proxy prefix)
    window.BASE_PATH = '{{ app.request.basePath }}';

    // Panel stack tracks layered task IDs
    window._panelStack = [];

    function _loadingSpinner() {
        return `<div class="flex items-center justify-center h-full">
            <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>`;
    }

    function _errorContent() {
        return `<div class="flex flex-col items-center justify-center h-full text-center p-6">
            <svg class="h-12 w-12 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
            <p class="text-gray-900 font-medium">Failed to load task</p>
            <p class="text-gray-500 text-sm mt-1">Please try again</p>
            <button onclick="closeTaskPanel()" class="mt-4 text-sm text-primary-600 hover:text-primary-500">Close</button>
        </div>`;
    }

    function _updatePanelCloseButtons() {
        const stack = document.getElementById('task-panel-stack');
        if (!stack) return;
        const layers = stack.querySelectorAll('.panel-layer');
        layers.forEach((layer, idx) => {
            const backIcon = layer.querySelector('.panel-back-icon');
            const closeIcon = layer.querySelector('.panel-close-icon');
            if (backIcon && closeIcon) {
                if (idx > 0) {
                    backIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                } else {
                    backIcon.classList.add('hidden');
                    closeIcon.classList.remove('hidden');
                }
            }
        });
    }

    function _fetchPanelContent(layer, taskId) {
        fetch(`${BASE_PATH}/tasks/${taskId}/panel`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => { if (!r.ok) throw new Error('Failed'); return r.text(); })
        .then(html => {
            layer.innerHTML = html;
            _updatePanelCloseButtons();
            if (typeof mountVueComponents === 'function') mountVueComponents();
        })
        .catch(() => { layer.innerHTML = _errorContent(); });
    }

    // Use openTaskPanel for normal opens; use pushSubtaskPanel from within a panel
    function openTaskPanel(taskId, updateUrl = true) {
        const panel = document.getElementById('task-panel');
        const overlay = document.getElementById('task-panel-overlay');
        const stack = document.getElementById('task-panel-stack');
        const content = document.getElementById('task-panel-content');

        // Always reset stack â€” clean slate for a fresh task open
        _panelStack = [taskId];
        stack.querySelectorAll('.panel-layer:not(#task-panel-content)').forEach(el => el.remove());
        content.style.transform = '';
        content.style.opacity = '';
        content.style.pointerEvents = '';
        content.style.transition = '';
        content.dataset.taskId = taskId;
        content.innerHTML = _loadingSpinner();

        panel.classList.remove('translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        document.body.style.overflow = 'hidden';

        _fetchPanelContent(content, taskId);

        if (updateUrl) {
            const url = new URL(window.location);
            url.searchParams.set('task', taskId);
            window.history.pushState({ taskId }, '', url);
        }
    }

    // Push a subtask panel on top of the current one (called from within panel)
    function pushSubtaskPanel(taskId) {
        const panel = document.getElementById('task-panel');
        const stack = document.getElementById('task-panel-stack');
        const isPanelOpen = !panel.classList.contains('translate-x-full');

        if (!isPanelOpen) {
            // Fallback: open normally if panel isn't open
            openTaskPanel(taskId);
            return;
        }

        const currentLayer = stack.querySelector('.panel-layer:last-child');
        currentLayer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
        currentLayer.style.transform = 'translateX(-100%)';
        currentLayer.style.opacity = '0';
        currentLayer.style.pointerEvents = 'none';

        const newLayer = document.createElement('div');
        newLayer.className = 'panel-layer absolute inset-0 h-full bg-white';
        newLayer.dataset.taskId = taskId;
        newLayer.innerHTML = _loadingSpinner();
        newLayer.style.transform = 'translateX(100%)';
        newLayer.style.transition = 'transform 0.3s ease-in-out';
        stack.appendChild(newLayer);

        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                newLayer.style.transform = 'translateX(0)';
            });
        });

        _panelStack.push(taskId);
        _fetchPanelContent(newLayer, taskId);

        const url = new URL(window.location);
        url.searchParams.set('task', taskId);
        window.history.pushState({ taskId }, '', url);
    }

    function closeTaskPanel(updateUrl = true) {
        const panel = document.getElementById('task-panel');
        const overlay = document.getElementById('task-panel-overlay');
        const stack = document.getElementById('task-panel-stack');
        const layers = stack.querySelectorAll('.panel-layer');

        // If there are stacked layers, pop the top one (go back to parent)
        if (layers.length > 1) {
            const topLayer = layers[layers.length - 1];
            const parentLayer = layers[layers.length - 2];

            topLayer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
            topLayer.style.transform = 'translateX(100%)';
            topLayer.style.opacity = '0';

            parentLayer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
            parentLayer.style.transform = 'translateX(0)';
            parentLayer.style.opacity = '1';
            parentLayer.style.pointerEvents = '';

            setTimeout(() => { topLayer.remove(); }, 300);

            _panelStack.pop();

            if (updateUrl) {
                const url = new URL(window.location);
                const parentTaskId = _panelStack[_panelStack.length - 1];
                if (parentTaskId) {
                    url.searchParams.set('task', parentTaskId);
                }
                window.history.pushState({ taskId: parentTaskId }, '', url);
            }
            return;
        }

        // Otherwise close the whole panel
        panel.classList.add('translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
        document.body.style.overflow = '';
        _panelStack = [];

        // Clean up extra layers after transition
        setTimeout(() => {
            const extras = stack.querySelectorAll('.panel-layer:not(#task-panel-content)');
            extras.forEach(el => el.remove());
            // Reset the base layer
            const base = document.getElementById('task-panel-content');
            if (base) {
                base.style.transform = '';
                base.style.opacity = '';
                base.style.pointerEvents = '';
                base.style.transition = '';
                base.dataset.taskId = '';
            }
        }, 350);

        if (updateUrl) {
            const url = new URL(window.location);
            url.searchParams.delete('task');
            url.searchParams.delete('create-task');
            window.history.pushState({}, '', url);
        }
    }

    function openTaskCreatePanel(projectId, updateUrl = true) {
        const panel = document.getElementById('task-panel');
        const overlay = document.getElementById('task-panel-overlay');
        const stack = document.getElementById('task-panel-stack');
        const content = document.getElementById('task-panel-content');

        // Reset stack â€” remove any extra layers
        _panelStack = [];
        stack.querySelectorAll('.panel-layer:not(#task-panel-content)').forEach(el => el.remove());
        content.style.transform = '';
        content.style.opacity = '';
        content.style.pointerEvents = '';
        content.style.transition = '';

        if (updateUrl) {
            const url = new URL(window.location);
            url.searchParams.delete('task');
            url.searchParams.set('create-task', projectId);
            window.history.pushState({ createTask: projectId }, '', url);
        }

        content.innerHTML = _loadingSpinner();

        panel.classList.remove('translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
        document.body.style.overflow = 'hidden';

        fetch(`${BASE_PATH}/projects/${projectId}/tasks/create-panel`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => { if (!r.ok) throw new Error('Failed'); return r.text(); })
        .then(html => {
            content.innerHTML = html;
            if (typeof mountVueComponents === 'function') mountVueComponents();
        })
        .catch(() => { content.innerHTML = _errorContent(); });
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(e) {
        const url = new URL(window.location);
        const taskId = url.searchParams.get('task');
        const createTaskProjectId = url.searchParams.get('create-task');
        const panel = document.getElementById('task-panel');
        const isOpen = panel && !panel.classList.contains('translate-x-full');

        if (taskId && !isOpen) {
            openTaskPanel(taskId, false);
        } else if (createTaskProjectId && !isOpen) {
            openTaskCreatePanel(createTaskProjectId, false);
        } else if (!taskId && !createTaskProjectId && isOpen) {
            closeTaskPanel(false);
        }
    });

    // Open task panel if task or create-task param exists on page load
    document.addEventListener('DOMContentLoaded', function() {
        const url = new URL(window.location);
        const taskId = url.searchParams.get('task');
        const createTaskProjectId = url.searchParams.get('create-task');
        if (taskId) {
            openTaskPanel(taskId, false);
        } else if (createTaskProjectId) {
            openTaskCreatePanel(createTaskProjectId, false);
        }
    });

    // Close on Escape key (pops stack or closes panel)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const panel = document.getElementById('task-panel');
            if (panel && !panel.classList.contains('translate-x-full')) {
                closeTaskPanel();
            }
            // Also close any open dropdowns
            closeAllDropdowns();
        }
    });

    // ===== INLINE EDITING FUNCTIONS =====

    // Permission-aware error message helper
    function getErrorMessage(response, fallback) {
        if (response && response.status === 403) {
            return "You don't have permission to perform this action";
        }
        return fallback;
    }

    // Close all dropdowns
    function closeAllDropdowns() {
        document.querySelectorAll('.status-dropdown, .priority-dropdown, .milestone-dropdown, .add-assignee-dropdown, .move-task-dropdown').forEach(d => {
            d.classList.add('hidden');
        });
    }

    // Click outside to close dropdowns
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.status-badge-btn, .status-dropdown, .priority-badge-btn, .priority-dropdown, .milestone-btn, .milestone-dropdown, .add-assignee-btn, .add-assignee-dropdown, #move-task-btn, .move-task-dropdown')) {
            closeAllDropdowns();
        }
    });

    // Toggle Status Dropdown
    function toggleStatusDropdown(btn, event) {
        if (event) event.stopPropagation();
        const dropdown = btn.parentElement.querySelector('.status-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Toggle Priority Dropdown
    function togglePriorityDropdown(btn, event) {
        if (event) event.stopPropagation();
        const dropdown = btn.parentElement.querySelector('.priority-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Toggle Milestone Dropdown
    function toggleMilestoneDropdown(btn, event) {
        if (event) event.stopPropagation();
        const dropdown = btn.parentElement.querySelector('.milestone-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Subtask completion modal state
    let _pendingStatusUpdate = null;

    function openSubtaskCompletionModal(taskId, status, btn, openSubtaskCount) {
        _pendingStatusUpdate = { taskId, status, btn };
        const message = document.getElementById('subtask-completion-message');
        message.textContent = `This task has ${openSubtaskCount} open subtask${openSubtaskCount > 1 ? 's' : ''}. How would you like to proceed?`;
        document.getElementById('subtask-completion-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeSubtaskCompletionModal() {
        document.getElementById('subtask-completion-modal').classList.add('hidden');
        document.body.style.overflow = '';
        _pendingStatusUpdate = null;
    }

    async function confirmCompleteParentOnly() {
        if (!_pendingStatusUpdate) return;
        const { taskId, status, btn } = _pendingStatusUpdate;
        closeSubtaskCompletionModal();
        // Re-call with completeSubtasks=false to force completion
        await doUpdateTaskStatus(taskId, status, btn, false, true);
    }

    async function confirmCompleteWithSubtasks() {
        if (!_pendingStatusUpdate) return;
        const { taskId, status, btn } = _pendingStatusUpdate;
        closeSubtaskCompletionModal();
        // Complete parent and all subtasks
        await doUpdateTaskStatus(taskId, status, btn, true, true);
    }

    // Update Task Status
    async function updateTaskStatus(taskId, status, btn) {
        await doUpdateTaskStatus(taskId, status, btn, false, false);
    }

    async function doUpdateTaskStatus(taskId, status, btn, completeSubtasks, forceComplete) {
        // Get label and color from the clicked button (dynamic from database)
        const statusLabel = btn.textContent.trim();
        const statusColor = btn.getAttribute('data-color') || '#6B7280';

        try {
            const body = { status };
            if (completeSubtasks) {
                body.completeSubtasks = true;
            }

            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to update status'));
                closeAllDropdowns();
                return;
            }

            const data = await response.json();

            // Check if we got a warning about open subtasks
            if (data.warning && data.openSubtaskCount > 0 && !forceComplete) {
                closeAllDropdowns();
                openSubtaskCompletionModal(taskId, status, btn, data.openSubtaskCount);
                return;
            }

            // Prefer color from response (more authoritative), fallback to button data
            const finalColor = data.statusColor || statusColor;
            const finalLabel = data.statusLabel || statusLabel;

            // Update the badge - uses inline styles with color-mix
            const badgeBtn = btn.closest('.status-dropdown').previousElementSibling;
            badgeBtn.querySelector('.status-label').textContent = finalLabel;
            badgeBtn.style.backgroundColor = `color-mix(in srgb, ${finalColor} 15%, white)`;
            badgeBtn.style.color = `color-mix(in srgb, ${finalColor} 80%, black)`;
            badgeBtn.setAttribute('data-current', status);
            badgeBtn.setAttribute('data-color', finalColor);

            closeAllDropdowns();

            if (data.completedSubtaskIds && data.completedSubtaskIds.length > 0) {
                Toastr.success('Status updated', `Task and ${data.completedSubtaskIds.length} subtask(s) completed`);
            } else {
                Toastr.success('Status updated');
            }

            // Notify other components (e.g., KanbanBoard, GanttView)
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'status', value: status, label: finalLabel, color: finalColor, completedSubtaskIds: data.completedSubtaskIds }
            }));
        } catch (error) {
            console.error('Error updating status:', error);
            Toastr.error('Failed to update status');
        }
    }

    // Update Task Priority
    async function updateTaskPriority(taskId, priority, btn) {
        const priorityLabels = {
            'none': 'None',
            'low': 'Low',
            'medium': 'Medium',
            'high': 'High'
        };
        const priorityColors = {
            'none': 'bg-gray-100 text-gray-700',
            'low': 'bg-blue-100 text-blue-700',
            'medium': 'bg-yellow-100 text-yellow-700',
            'high': 'bg-red-100 text-red-700'
        };

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/priority`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ priority: priority })
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to update priority'));
                closeAllDropdowns();
                return;
            }

            // Update the badge
            const badgeBtn = btn.closest('.priority-dropdown').previousElementSibling;
            badgeBtn.querySelector('.priority-label').textContent = priorityLabels[priority];
            badgeBtn.className = badgeBtn.className.replace(/bg-\w+-100 text-\w+-700/g, '');
            badgeBtn.classList.add(...priorityColors[priority].split(' '));

            closeAllDropdowns();
            Toastr.success('Priority updated');

            // Notify other components (e.g., KanbanBoard)
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'priority', value: priority, label: priorityLabels[priority] }
            }));
        } catch (error) {
            console.error('Error updating priority:', error);
            Toastr.error('Failed to update priority');
        }
    }

    // Update Task Milestone
    async function updateTaskMilestone(taskId, milestoneId, milestoneName, btn) {
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/milestone`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ milestone: milestoneId })
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to update milestone'));
                closeAllDropdowns();
                return;
            }

            // Update the label
            const milestoneBtn = btn.closest('.milestone-dropdown').previousElementSibling;
            milestoneBtn.querySelector('.milestone-label').textContent = milestoneName;

            closeAllDropdowns();
            Toastr.success('Milestone updated');

            // Notify other components (e.g., KanbanBoard)
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'milestone', value: milestoneId, label: milestoneName }
            }));
        } catch (error) {
            console.error('Error updating milestone:', error);
            Toastr.error('Failed to update milestone');
        }
    }

    // Update Start Date
    async function updateStartDate(input) {
        const endpoint = input.dataset.endpoint;
        const value = input.value;
        const originalValue = input.dataset.original || '';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ startDate: value || null })
            });

            if (!response.ok) {
                input.value = originalValue;
                Toastr.error(getErrorMessage(response, 'Failed to update start date'));
                return;
            }

            const data = await response.json();

            // Update the original value
            input.dataset.original = value;

            // Remove placeholder and update text visibility
            const placeholder = input.parentElement.querySelector('.start-date-placeholder');
            if (value) {
                if (placeholder) placeholder.remove();
                input.classList.remove('text-transparent');
                input.classList.add('text-gray-900');
            } else {
                input.classList.remove('text-gray-900');
                input.classList.add('text-transparent');
            }

            Toastr.success('Start date updated');

            // Notify other components
            const taskId = endpoint.match(/\/tasks\/([^\/]+)\//)?.[1];
            if (taskId) {
                document.dispatchEvent(new CustomEvent('task-updated', {
                    detail: { taskId, field: 'startDate', value: value || null }
                }));
            }
        } catch (error) {
            console.error('Error updating start date:', error);
            Toastr.error(error.message || 'Failed to update start date');
        }
    }

    // Update Due Date
    async function updateDueDate(input) {
        const endpoint = input.dataset.endpoint;
        const value = input.value;
        const originalValue = input.dataset.original || '';

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ dueDate: value || null })
            });

            if (!response.ok) {
                input.value = originalValue;
                Toastr.error(getErrorMessage(response, 'Failed to update due date'));
                return;
            }

            const data = await response.json();

            // Update the original value
            input.dataset.original = value;

            // Update styling based on value and overdue status
            input.classList.remove('text-transparent', 'text-gray-900', 'text-red-600', 'font-medium');
            if (value) {
                if (data.isOverdue) {
                    input.classList.add('text-red-600', 'font-medium');
                } else {
                    input.classList.add('text-gray-900');
                }
            } else {
                input.classList.add('text-transparent');
            }

            // Remove placeholder if value is set
            const placeholder = input.parentElement.querySelector('.due-date-placeholder');
            if (placeholder && value) {
                placeholder.remove();
            }

            Toastr.success('Due date updated');

            // Notify other components (e.g., KanbanBoard)
            const taskId = endpoint.match(/\/tasks\/([^\/]+)\//)?.[1];
            if (taskId) {
                document.dispatchEvent(new CustomEvent('task-updated', {
                    detail: { taskId, field: 'dueDate', value: value || null }
                }));
            }
        } catch (error) {
            console.error('Error updating due date:', error);
            Toastr.error(error.message || 'Failed to update due date');
        }
    }

    // Title editing - contenteditable
    document.addEventListener('blur', async function(e) {
        if (e.target.classList.contains('editable-title')) {
            const endpoint = e.target.dataset.endpoint;
            const original = e.target.dataset.original;
            const newValue = e.target.textContent.trim();

            if (newValue === original) return;
            if (!newValue) {
                e.target.textContent = original;
                Toastr.error('Title cannot be empty');
                return;
            }

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ title: newValue })
                });

                if (!response.ok) {
                    e.target.textContent = original;
                    Toastr.error(getErrorMessage(response, 'Failed to update title'));
                    return;
                }

                e.target.dataset.original = newValue;
                Toastr.success('Title updated');

                // Notify other components (e.g., KanbanBoard)
                const taskId = endpoint.match(/\/tasks\/([^\/]+)\//)?.[1];
                if (taskId) {
                    document.dispatchEvent(new CustomEvent('task-updated', {
                        detail: { taskId, field: 'title', value: newValue }
                    }));
                }
            } catch (error) {
                console.error('Error updating title:', error);
                e.target.textContent = original;
                Toastr.error('Failed to update title');
            }
        }
    }, true);

    // Prevent Enter from creating new line in title
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('editable-title') && e.key === 'Enter') {
            e.preventDefault();
            e.target.blur();
        }
        // Escape to cancel edit
        if (e.target.classList.contains('editable-title') && e.key === 'Escape') {
            e.target.textContent = e.target.dataset.original;
            e.target.blur();
        }
    });

    // Description editing
    function showDescriptionEditor(displayEl) {
        const container = displayEl.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const textarea = editor.querySelector('textarea');

        displayEl.classList.add('hidden');
        editor.classList.remove('hidden');
        textarea.focus();
    }

    function cancelDescriptionEdit(btn) {
        const container = btn.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const display = container.querySelector('.description-display');
        const textarea = editor.querySelector('textarea');

        textarea.value = textarea.dataset.original || '';
        editor.classList.add('hidden');
        display.classList.remove('hidden');
    }

    async function saveDescription(btn) {
        const container = btn.closest('.description-container');
        const editor = container.querySelector('.description-editor');
        const display = container.querySelector('.description-display');
        const textarea = editor.querySelector('textarea');
        const endpoint = textarea.dataset.endpoint;
        const newValue = textarea.value.trim();

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ description: newValue })
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to update description'));
                return;
            }

            textarea.dataset.original = newValue;

            if (newValue) {
                display.textContent = newValue;
                display.classList.remove('text-gray-400', 'italic');
                display.classList.add('text-gray-600');
            } else {
                display.textContent = display.dataset.placeholder;
                display.classList.add('text-gray-400', 'italic');
                display.classList.remove('text-gray-600');
            }

            editor.classList.add('hidden');
            display.classList.remove('hidden');
            Toastr.success('Description updated');

            // Notify other components
            const taskId = endpoint.match(/\/tasks\/([^\/]+)\//)?.[1];
            if (taskId) {
                document.dispatchEvent(new CustomEvent('task-updated', {
                    detail: { taskId, field: 'description', value: newValue }
                }));
            }
        } catch (error) {
            console.error('Error updating description:', error);
            Toastr.error('Failed to update description');
        }
    }

    // Assignee management
    async function removeAssignee(taskId, userId, btn) {
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/assignees`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'remove', userId: userId })
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to remove assignee'));
                return;
            }

            // Remove the chip
            const chip = btn.closest('.assignee-chip');
            chip.remove();

            // Show "No assignees" if empty
            const container = document.querySelector('.assignees-container');
            const chips = container.querySelectorAll('.assignee-chip');
            if (chips.length === 0) {
                const noMsg = document.createElement('p');
                noMsg.className = 'no-assignees-msg text-sm text-gray-400 italic mt-2';
                noMsg.textContent = 'No assignees';
                container.parentElement.appendChild(noMsg);
            }

            Toastr.success('Assignee removed');

            // Notify other components
            dispatchAssigneesUpdated(taskId, container);
        } catch (error) {
            console.error('Error removing assignee:', error);
            Toastr.error('Failed to remove assignee');
        }
    }

    // Helper to dispatch assignee update events
    function dispatchAssigneesUpdated(taskId, container) {
        const chips = container.querySelectorAll('.assignee-chip');
        const assignees = Array.from(chips).map(chip => {
            const initials = chip.querySelector('.text-primary-700')?.textContent?.trim() || '';
            const fullName = chip.textContent.replace(initials, '').trim();
            return {
                id: chip.dataset.userId,
                user: {
                    id: chip.dataset.userId,
                    fullName: fullName,
                    firstName: fullName.split(' ')[0] || ''
                }
            };
        });
        document.dispatchEvent(new CustomEvent('task-assignees-updated', {
            detail: { taskId, assignees }
        }));
    }

    async function showAddAssigneeDropdown(btn) {
        const container = btn.closest('.assignees-container');
        const dropdown = container.querySelector('.add-assignee-dropdown');
        const projectId = container.dataset.projectId;
        const taskId = container.dataset.taskId;

        // Position the dropdown near the button
        const btnRect = btn.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        dropdown.style.left = (btnRect.left - containerRect.left) + 'px';

        closeAllDropdowns();
        dropdown.classList.remove('hidden');

        // Load project members
        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/members`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('Failed to load members');

            const data = await response.json();
            const currentAssignees = Array.from(container.querySelectorAll('.assignee-chip'))
                .map(chip => chip.dataset.userId);

            // Filter out already assigned members
            const availableMembers = data.members.filter(m => !currentAssignees.includes(m.id));

            const dropdownContent = dropdown.querySelector('.py-1');
            if (availableMembers.length === 0) {
                dropdownContent.innerHTML = '<div class="px-4 py-2 text-sm text-gray-500">No more members to add</div>';
            } else {
                dropdownContent.innerHTML = availableMembers.map(member => `
                    <button type="button"
                            onclick="addAssignee('${taskId}', '${member.id}', '${member.fullName}', '${member.initials}', this)"
                            class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                            <span class="text-xs font-medium text-primary-700">${member.initials}</span>
                        </span>
                        ${member.fullName}
                    </button>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading members:', error);
            dropdown.querySelector('.py-1').innerHTML = '<div class="px-4 py-2 text-sm text-red-500">Failed to load members</div>';
        }
    }

    async function addAssignee(taskId, userId, fullName, initials, btn) {
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/assignees`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ action: 'add', userId: userId })
            });

            if (!response.ok) {
                Toastr.error(getErrorMessage(response, 'Failed to add assignee'));
                closeAllDropdowns();
                return;
            }

            // Add the new chip before the Add button
            const container = document.querySelector('.assignees-container');
            const addBtn = container.querySelector('.add-assignee-btn');

            const chip = document.createElement('span');
            chip.className = 'assignee-chip inline-flex items-center rounded-full bg-gray-100 py-1 pl-2 pr-1 text-sm font-medium text-gray-800';
            chip.dataset.userId = userId;
            chip.innerHTML = `
                <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                    <span class="text-xs font-medium text-primary-700">${initials}</span>
                </span>
                ${fullName}
                <button type="button"
                        onclick="removeAssignee('${taskId}', '${userId}', this)"
                        class="ml-1 inline-flex h-5 w-5 items-center justify-center rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;

            container.querySelector('.assignees-list').insertBefore(chip, addBtn);

            // Remove "No assignees" message
            const noMsg = container.parentElement.querySelector('.no-assignees-msg');
            if (noMsg) noMsg.remove();

            closeAllDropdowns();
            Toastr.success('Assignee added');

            // Notify other components
            dispatchAssigneesUpdated(taskId, container);
        } catch (error) {
            console.error('Error adding assignee:', error);
            Toastr.error('Failed to add assignee');
        }
    }

    // Move Task Dropdown
    function toggleMoveTaskDropdown(btn, event) {
        if (event) event.stopPropagation();
        const dropdown = btn.parentElement.querySelector('.move-task-dropdown');
        const isHidden = dropdown.classList.contains('hidden');
        closeAllDropdowns();
        if (isHidden) {
            dropdown.classList.remove('hidden');
        }
    }

    // Promote task (move to parent's level)
    async function promoteTask(taskId) {
        closeAllDropdowns();
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/parent`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ parentId: null })
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                Toastr.error(data.error || 'Failed to promote task');
                return;
            }

            Toastr.success('Task promoted to parent level');

            // Refresh the panel to show updated state
            const panelContent = document.getElementById('task-panel-content');
            if (panelContent) {
                openTaskPanel(taskId);
            }

            // Notify other components
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'parent', value: null }
            }));
        } catch (error) {
            console.error('Error promoting task:', error);
            Toastr.error('Failed to promote task');
        }
    }

    // Task picker modal state
    let _taskPickerResolve = null;
    let _taskPickerTaskId = null;

    function openMoveToParentModal(taskId, milestoneId, projectId) {
        closeAllDropdowns();
        _taskPickerTaskId = taskId;

        // Load eligible parent tasks
        loadEligibleParents(taskId, milestoneId, projectId);

        document.getElementById('task-picker-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Focus search input
        setTimeout(() => {
            document.getElementById('task-picker-search')?.focus();
        }, 100);
    }

    function closeTaskPickerModal() {
        document.getElementById('task-picker-modal').classList.add('hidden');
        document.body.style.overflow = '';
        _taskPickerTaskId = null;
        document.getElementById('task-picker-search').value = '';
    }

    async function loadEligibleParents(taskId, milestoneId, projectId) {
        const container = document.getElementById('task-picker-list');
        container.innerHTML = '<div class="px-4 py-8 text-center text-gray-500">Loading...</div>';

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/eligible-parents`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) {
                throw new Error('Failed to load tasks');
            }

            const data = await response.json();
            const tasks = data.tasks || [];

            if (tasks.length === 0) {
                container.innerHTML = '<div class="px-4 py-8 text-center text-gray-500">No eligible parent tasks found</div>';
                return;
            }

            // Store tasks for filtering
            container.dataset.tasks = JSON.stringify(tasks);
            renderTaskPickerList(tasks);
        } catch (e) {
            console.error('Error loading eligible parents:', e);
            container.innerHTML = '<div class="px-4 py-8 text-center text-red-500">Failed to load tasks</div>';
        }
    }

    function renderTaskPickerList(tasks) {
        const container = document.getElementById('task-picker-list');

        if (tasks.length === 0) {
            container.innerHTML = '<div class="px-4 py-8 text-center text-gray-500">No matching tasks</div>';
            return;
        }

        container.innerHTML = tasks.map(task => {
            const depthPadding = '\u00A0'.repeat((task.depth || 0) * 4);
            const depthPrefix = task.depth > 0 ? depthPadding + '\u2514\u2500 ' : '';
            const statusClass = {
                'completed': 'bg-green-100 text-green-700',
                'in_progress': 'bg-blue-100 text-blue-700',
                'in_review': 'bg-yellow-100 text-yellow-700',
                'todo': 'bg-gray-100 text-gray-700'
            }[task.status?.value] || 'bg-gray-100 text-gray-700';

            return `
                <button type="button"
                        onclick="selectNewParent('${task.id}')"
                        class="w-full text-left px-4 py-3 hover:bg-gray-50 focus:bg-gray-50 focus:outline-none border-b border-gray-100 last:border-0">
                    <div class="flex items-center">
                        <span class="text-gray-400 text-sm font-mono whitespace-pre">${depthPrefix}</span>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">${escapeHtml(task.title)}</div>
                            <div class="text-xs text-gray-500 mt-0.5">
                                <span class="inline-flex items-center rounded px-1.5 py-0.5 text-xs font-medium ${statusClass}">
                                    ${task.status?.label || 'To Do'}
                                </span>
                                ${task.subtaskCount > 0 ? `<span class="ml-2 text-gray-400">${task.subtaskCount} subtask${task.subtaskCount > 1 ? 's' : ''}</span>` : ''}
                            </div>
                        </div>
                        <svg class="h-4 w-4 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </div>
                </button>
            `;
        }).join('');
    }

    function filterTaskPickerList() {
        const container = document.getElementById('task-picker-list');
        const search = document.getElementById('task-picker-search').value.toLowerCase();
        const allTasks = JSON.parse(container.dataset.tasks || '[]');

        if (!search) {
            renderTaskPickerList(allTasks);
            return;
        }

        const filtered = allTasks.filter(t => t.title.toLowerCase().includes(search));
        renderTaskPickerList(filtered);
    }

    async function selectNewParent(newParentId) {
        if (!_taskPickerTaskId) return;

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${_taskPickerTaskId}/parent`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ parentId: newParentId })
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                Toastr.error(data.error || 'Failed to move task');
                return;
            }

            closeTaskPickerModal();
            Toastr.success('Task moved to new parent');

            // Refresh the panel to show updated state
            const taskId = _taskPickerTaskId;
            openTaskPanel(taskId);

            // Notify other components
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'parent', value: newParentId }
            }));
        } catch (error) {
            console.error('Error moving task:', error);
            Toastr.error('Failed to move task');
        }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Delete task with subtask count warning
    async function confirmDeleteTask(taskId, taskTitle, subtaskCount) {
        let message = `Are you sure you want to delete "${taskTitle}"?`;
        if (subtaskCount > 0) {
            message += ` This task has ${subtaskCount} subtask${subtaskCount > 1 ? 's' : ''} that will also be deleted.`;
        }
        message += ' This action cannot be undone.';

        if (!confirm(message)) {
            return;
        }

        try {
            const response = await fetch(`${BASE_PATH}/tasks/bulk-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ taskIds: [taskId] })
            });

            if (!response.ok) {
                Toastr.error('Failed to delete task');
                return;
            }

            Toastr.success('Task deleted');

            // Close the panel
            closeTaskPanel();

            // Notify other components
            document.dispatchEvent(new CustomEvent('task-deleted', {
                detail: { taskId }
            }));
        } catch (error) {
            console.error('Error deleting task:', error);
            Toastr.error('Failed to delete task');
        }
    }

    // Comment handling
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('comment-textarea')) {
            const btn = e.target.closest('.add-comment-form').querySelector('.add-comment-btn');
            btn.disabled = !e.target.value.trim();
        }
    });

    async function addComment(taskId, btn) {
        const form = btn.closest('.add-comment-form');
        const textarea = form.querySelector('.comment-textarea');
        const content = textarea.value.trim();

        if (!content) return;

        btn.disabled = true;
        btn.textContent = 'Posting...';

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/comments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ content: content })
            });

            if (!response.ok) throw new Error('Failed to add comment');

            const data = await response.json();

            // Add the new comment to the list
            const commentsList = document.querySelector('.comments-list');

            // Remove "No comments" message if present
            const noMsg = commentsList.querySelector('.no-comments-msg');
            if (noMsg) noMsg.remove();

            const commentEl = document.createElement('div');
            commentEl.className = 'comment-item bg-gray-50 rounded-lg p-3';
            commentEl.dataset.commentId = data.comment.id;
            commentEl.innerHTML = `
                <div class="flex items-center mb-2">
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-primary-100 mr-2">
                        <span class="text-xs font-medium text-primary-700">${data.comment.authorInitials}</span>
                    </span>
                    <span class="text-sm font-medium text-gray-900">${data.comment.authorName}</span>
                    <span class="ml-auto text-xs text-gray-500">${data.comment.createdAt}</span>
                </div>
                <p class="text-sm text-gray-600 whitespace-pre-wrap">${escapeHtml(data.comment.content)}</p>
            `;

            // Insert at the beginning (newest first)
            commentsList.prepend(commentEl);

            // Update comment count
            const countSpan = document.querySelector('.comments-count');
            const currentCount = parseInt(countSpan.textContent.replace(/[()]/g, '') || '0');
            countSpan.textContent = `(${currentCount + 1})`;

            // Clear the form
            textarea.value = '';
            btn.textContent = 'Post Comment';
            btn.disabled = true;

            Toastr.success('Comment added');
        } catch (error) {
            console.error('Error adding comment:', error);
            btn.textContent = 'Post Comment';
            btn.disabled = false;
            Toastr.error('Failed to add comment');
        }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== TAB SWITCHING =====
    function switchTab(tabName, btn) {
        // Update tab buttons
        const tabBtns = btn.closest('.task-panel-tabs').querySelectorAll('.tab-btn');
        tabBtns.forEach(b => {
            if (b.dataset.tab === tabName) {
                b.classList.add('text-gray-700', 'border-primary-600');
                b.classList.remove('text-gray-500', 'border-transparent');
            } else {
                b.classList.remove('text-gray-700', 'border-primary-600');
                b.classList.add('text-gray-500', 'border-transparent');
            }
        });

        // Update tab content
        const tabContents = btn.closest('.task-panel-tabs').querySelectorAll('.tab-content');
        tabContents.forEach(content => {
            if (content.id === `tab-${tabName}`) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        });
    }

    // ===== CHECKLIST FUNCTIONS =====

    // Add checklist item
    async function addChecklistItem(taskId, input) {
        const title = input.value.trim();
        if (!title) return;

        const originalValue = input.value;
        input.value = '';
        input.disabled = true;

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/checklists`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ title: title })
            });

            if (!response.ok) throw new Error('Failed to add checklist item');

            const data = await response.json();
            const item = data.item;

            // Add the new item to the list
            const checklistContainer = input.closest('.checklist-container');
            const checklistItems = checklistContainer.querySelector('.checklist-items');

            // Remove "No checklist items" message if present
            const noMsg = checklistContainer.querySelector('.no-checklist-msg');
            if (noMsg) noMsg.remove();
            const itemEl = document.createElement('div');
            itemEl.className = 'checklist-item group flex items-center gap-2 p-2 rounded-md hover:bg-gray-50';
            itemEl.dataset.itemId = item.id;
            itemEl.draggable = true;
            itemEl.innerHTML = `
                <div class="checklist-drag-handle cursor-grab text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </div>
                <input type="checkbox"
                       class="checklist-checkbox h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                       onchange="toggleChecklistItem('${taskId}', '${item.id}', this)">
                <span class="checklist-item-title flex-1 text-sm cursor-pointer text-gray-900"
                      onclick="editChecklistItem(this, '${taskId}', '${item.id}')"
                      data-original="${escapeHtml(item.title)}">${escapeHtml(item.title)}</span>
                <button type="button"
                        onclick="deleteChecklistItem('${taskId}', '${item.id}', this)"
                        class="checklist-delete-btn opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-red-600">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                </button>
            `;
            checklistItems.appendChild(itemEl);

            // Update progress
            updateChecklistProgress(checklistContainer);

            input.disabled = false;
            input.focus();
            Toastr.success('Checklist item added');
        } catch (error) {
            console.error('Error adding checklist item:', error);
            input.value = originalValue;
            input.disabled = false;
            Toastr.error('Failed to add checklist item');
        }
    }

    // Toggle checklist item
    async function toggleChecklistItem(taskId, itemId, checkbox) {
        checkbox.disabled = true;

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/checklists/${itemId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to toggle checklist item');

            const data = await response.json();
            const item = data.item;

            // Update the title styling
            const itemEl = checkbox.closest('.checklist-item');
            const titleEl = itemEl.querySelector('.checklist-item-title');

            if (item.isCompleted) {
                titleEl.classList.add('line-through', 'text-gray-400');
                titleEl.classList.remove('text-gray-900');
            } else {
                titleEl.classList.remove('line-through', 'text-gray-400');
                titleEl.classList.add('text-gray-900');
            }

            checkbox.disabled = false;

            // Update progress
            updateChecklistProgress(checkbox.closest('.checklist-container'));
        } catch (error) {
            console.error('Error toggling checklist item:', error);
            checkbox.checked = !checkbox.checked;
            checkbox.disabled = false;
            Toastr.error('Failed to toggle checklist item');
        }
    }

    // Edit checklist item
    function editChecklistItem(titleEl, taskId, itemId) {
        // Don't edit if already editing
        if (titleEl.querySelector('input')) return;

        const original = titleEl.dataset.original;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = original;
        input.className = 'w-full text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-primary-500 focus:border-primary-500';

        const saveEdit = async () => {
            const newValue = input.value.trim();

            if (!newValue) {
                titleEl.textContent = original;
                return;
            }

            if (newValue === original) {
                titleEl.textContent = original;
                return;
            }

            try {
                const response = await fetch(`${BASE_PATH}/tasks/${taskId}/checklists/${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/merge-patch+json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ title: newValue })
                });

                if (!response.ok) throw new Error('Failed to update checklist item');

                titleEl.dataset.original = newValue;
                titleEl.textContent = newValue;
                Toastr.success('Checklist item updated');
            } catch (error) {
                console.error('Error updating checklist item:', error);
                titleEl.textContent = original;
                Toastr.error('Failed to update checklist item');
            }
        };

        input.onblur = saveEdit;
        input.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                input.blur();
            } else if (e.key === 'Escape') {
                input.value = original;
                input.blur();
            }
        };

        titleEl.textContent = '';
        titleEl.appendChild(input);
        input.focus();
        input.select();
    }

    // Delete checklist item
    async function deleteChecklistItem(taskId, itemId, btn) {
        const itemEl = btn.closest('.checklist-item');
        const checklistContainer = itemEl.closest('.checklist-container');
        const checklistItems = checklistContainer.querySelector('.checklist-items');
        itemEl.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/checklists/${itemId}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to delete checklist item');

            itemEl.remove();

            // Show "No checklist items" if empty
            if (checklistItems.querySelectorAll('.checklist-item').length === 0) {
                const noMsg = document.createElement('p');
                noMsg.className = 'no-checklist-msg text-sm text-gray-400 italic py-4';
                noMsg.textContent = 'No checklist items yet';
                checklistItems.appendChild(noMsg);
            }

            // Update progress
            updateChecklistProgress(checklistContainer);

            Toastr.success('Checklist item deleted');
        } catch (error) {
            console.error('Error deleting checklist item:', error);
            itemEl.style.opacity = '1';
            Toastr.error('Failed to delete checklist item');
        }
    }

    // Update checklist progress bar
    function updateChecklistProgress(container) {
        // Find the container - either passed in or find first one
        const checklistContainer = container || document.querySelector('.checklist-container');
        if (!checklistContainer) return;

        const checklistItems = checklistContainer.querySelector('.checklist-items');
        if (!checklistItems) return;

        const items = checklistItems.querySelectorAll('.checklist-item');
        const totalCount = items.length;
        const completedCount = checklistItems.querySelectorAll('.checklist-checkbox:checked').length;

        const progressContainer = checklistContainer.querySelector('.checklist-progress');
        const progressText = checklistContainer.querySelector('.checklist-progress-text');
        const progressBar = checklistContainer.querySelector('.checklist-progress-bar');
        const countSpan = checklistContainer.querySelector('.checklist-count');

        if (progressContainer) {
            if (totalCount === 0) {
                progressContainer.classList.add('hidden');
            } else {
                progressContainer.classList.remove('hidden');
                const percentage = (completedCount / totalCount) * 100;
                progressText.textContent = `${completedCount}/${totalCount}`;
                progressBar.style.width = `${percentage}%`;
            }
        }

        if (countSpan) {
            countSpan.textContent = `(${totalCount})`;
        }
    }

    // ===== CHECKLIST DRAG AND DROP =====
    window.draggedChecklistItem = null;

    document.addEventListener('mousedown', function(e) {
        // Only allow drag to start from the handle
        const handle = e.target.closest('.checklist-drag-handle');
        const checklistItem = e.target.closest('.checklist-item');
        if (checklistItem) {
            checklistItem.draggable = !!handle;
        }
    });

    document.addEventListener('dragstart', function(e) {
        const checklistItem = e.target.closest('.checklist-item');
        if (!checklistItem) return;

        draggedChecklistItem = checklistItem;
        draggedChecklistItem.classList.add('opacity-50');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', checklistItem.dataset.itemId);
    });

    document.addEventListener('dragend', function(e) {
        if (draggedChecklistItem) {
            draggedChecklistItem.classList.remove('opacity-50');
            draggedChecklistItem = null;
        }
        // Remove all drag-over styles
        document.querySelectorAll('.checklist-item').forEach(item => {
            item.classList.remove('border-t-2', 'border-primary-500');
        });
    });

    document.addEventListener('dragover', function(e) {
        const checklistItem = e.target.closest('.checklist-item');
        if (!checklistItem || !draggedChecklistItem || checklistItem === draggedChecklistItem) return;

        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        // Remove previous indicators
        document.querySelectorAll('.checklist-item').forEach(item => {
            item.classList.remove('border-t-2', 'border-primary-500');
        });

        // Add indicator to current target
        checklistItem.classList.add('border-t-2', 'border-primary-500');
    });

    document.addEventListener('drop', async function(e) {
        const targetItem = e.target.closest('.checklist-item');
        if (!targetItem || !draggedChecklistItem || targetItem === draggedChecklistItem) return;

        e.preventDefault();

        const checklistContainer = targetItem.closest('.checklist-items');
        if (!checklistContainer) return;
        const taskId = checklistContainer.dataset.taskId;
        const movedItem = draggedChecklistItem;

        // Move the dragged item before the target
        checklistContainer.insertBefore(movedItem, targetItem);

        // Remove drag-over styles
        targetItem.classList.remove('border-t-2', 'border-primary-500');

        // Get new order of item IDs
        const itemIds = Array.from(checklistContainer.querySelectorAll('.checklist-item'))
            .map(item => item.dataset.itemId);

        // Add saving indicator
        movedItem.classList.add('opacity-50');

        // Save new order to server
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/checklists/reorder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ itemIds: itemIds })
            });

            if (!response.ok) throw new Error('Failed to reorder');

            // Success feedback - brief highlight
            movedItem.classList.remove('opacity-50');
            movedItem.classList.add('bg-green-50');
            setTimeout(() => movedItem.classList.remove('bg-green-50'), 300);
            Toastr.success('Order updated');
        } catch (error) {
            console.error('Error reordering checklist items:', error);
            movedItem.classList.remove('opacity-50');
            Toastr.error('Failed to save new order');
        }
    });

    // ===== TAG FUNCTIONS =====
    window.tagSearchTimeout = null;
    window.selectedTagColor = '#3b82f6'; // Default blue

    // Search tags as user types
    function searchTags(input, taskId) {
        const query = input.value.trim();
        const container = input.closest('.add-tag-container');
        const dropdown = container.querySelector('.tag-dropdown');
        const createSection = dropdown.querySelector('.create-tag-section');
        const tagsGrid = dropdown.querySelector('.existing-tags-grid');
        const newTagPreview = dropdown.querySelector('.new-tag-preview');

        clearTimeout(tagSearchTimeout);

        if (query.length < 1) {
            dropdown.classList.add('hidden');
            return;
        }

        dropdown.classList.remove('hidden');

        tagSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`${BASE_PATH}/tags/search?q=${encodeURIComponent(query)}&limit=50`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();
                const tags = data.tags;

                // Get current tags on the task
                const currentTagIds = Array.from(document.querySelectorAll('.tags-container .tag-chip'))
                    .map(chip => chip.dataset.tagId);

                // Filter out already added tags
                const availableTags = tags.filter(t => !currentTagIds.includes(t.id));

                // Check if exact match exists
                const exactMatch = tags.find(t => t.name.toLowerCase() === query.toLowerCase());

                // Show/hide create section
                if (!exactMatch && query.length > 0) {
                    createSection.classList.remove('hidden');
                    newTagPreview.textContent = query;
                    newTagPreview.style.backgroundColor = selectedTagColor;
                    newTagPreview.style.setProperty('--tag-color', selectedTagColor);
                } else {
                    createSection.classList.add('hidden');
                }

                // Build tags grid
                if (availableTags.length > 0) {
                    tagsGrid.innerHTML = availableTags.map(tag => `
                        <button type="button"
                                onclick="addExistingTag('${taskId}', '${tag.id}', '${escapeHtml(tag.name)}', '${tag.color}')"
                                class="tag-chip inline-flex items-center text-xs font-medium text-white pl-2 pr-2 py-0.5 hover:opacity-80 transition-opacity"
                                style="background-color: ${tag.color}; --tag-color: ${tag.color};">
                            ${escapeHtml(tag.name)}
                        </button>
                    `).join('');
                } else if (exactMatch) {
                    tagsGrid.innerHTML = '<p class="text-sm text-gray-400 italic py-2">Tag already added to task</p>';
                } else {
                    tagsGrid.innerHTML = '';
                }
            } catch (error) {
                console.error('Error searching tags:', error);
            }
        }, 150);
    }

    // Handle Enter key in tag input
    function handleTagKeydown(event, input, taskId) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const query = input.value.trim();
            if (query.length > 0) {
                createTagWithColor(taskId);
            }
        } else if (event.key === 'Escape') {
            const container = input.closest('.add-tag-container');
            const dropdown = container.querySelector('.tag-dropdown');
            dropdown.classList.add('hidden');
            closeColorPicker();
            input.value = '';
        }
    }

    // Open color picker
    function openColorPicker(btn) {
        const popup = btn.closest('.create-tag-section').querySelector('.color-picker-popup');
        popup.classList.toggle('hidden');
    }

    // Close color picker
    function closeColorPicker() {
        const popups = document.querySelectorAll('.color-picker-popup');
        popups.forEach(p => p.classList.add('hidden'));
    }

    // Select tag color
    function selectTagColor(color) {
        selectedTagColor = color;
        const preview = document.querySelector('.new-tag-preview');
        if (preview) {
            preview.style.backgroundColor = color;
            preview.style.setProperty('--tag-color', color);
        }
        closeColorPicker();
    }

    // Add an existing tag to the task
    async function addExistingTag(taskId, tagId, tagName, tagColor) {
        console.log('addExistingTag called', { taskId, tagId, tagName, tagColor });

        const container = document.querySelector('.tags-container');
        const dropdown = container.querySelector('.tag-dropdown');
        const input = container.querySelector('.tag-search-input');

        dropdown.classList.add('hidden');
        input.value = '';

        try {
            console.log('Sending POST to', `/tasks/${taskId}/tags`);
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/tags`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: tagName })
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                throw new Error(errorData.error || 'Failed to add tag');
            }

            const data = await response.json();
            console.log('Success response:', data);
            addTagChipToUI(data.tag);
            Toastr.success('Tag added');
            input.focus();
        } catch (error) {
            console.error('Error adding tag:', error);
            Toastr.error('Failed to add tag');
            input.focus();
        }
    }

    // Create a new tag with selected color and add it to the task
    async function createTagWithColor(taskId) {
        const container = document.querySelector('.tags-container');
        const dropdown = container.querySelector('.tag-dropdown');
        const input = container.querySelector('.tag-search-input');
        const tagName = input.value.trim();

        console.log('createTagWithColor called', { taskId, tagName, selectedTagColor });

        if (!tagName) {
            console.log('Empty tag name, returning');
            return;
        }

        dropdown.classList.add('hidden');
        const savedTagName = tagName; // Save before clearing input
        input.value = '';

        // Check if tag already exists on task
        const existingChips = container.querySelectorAll('.tags-list > .tag-chip');
        for (const chip of existingChips) {
            if (chip.textContent.trim().toLowerCase() === savedTagName.toLowerCase()) {
                Toastr.info('Tag already added');
                input.focus();
                return;
            }
        }

        try {
            console.log('Sending POST to', `/tasks/${taskId}/tags`);
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/tags`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ name: savedTagName, color: selectedTagColor })
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                throw new Error(errorData.error || 'Failed to create tag');
            }

            const data = await response.json();
            console.log('Success response:', data);
            addTagChipToUI(data.tag);
            Toastr.success('Tag created');
            input.focus();

            // Reset color to default for next tag
            selectedTagColor = '#3b82f6';
        } catch (error) {
            console.error('Error creating tag:', error);
            Toastr.error(error.message || 'Failed to add tag');
            input.focus();
        }
    }

    // Add tag chip to the UI
    function addTagChipToUI(tag) {
        const container = document.querySelector('.tags-container');
        const tagsList = container.querySelector('.tags-list');
        const taskId = container.dataset.taskId;

        // Remove "No tags" message
        const noMsg = container.parentElement.querySelector('.no-tags-msg');
        if (noMsg) noMsg.remove();

        const chip = document.createElement('span');
        chip.className = 'tag-chip group relative inline-flex items-center text-xs font-medium text-white pl-2 pr-5 py-0.5';
        chip.style.backgroundColor = tag.color;
        chip.style.setProperty('--tag-color', tag.color);
        chip.dataset.tagId = tag.id;
        chip.innerHTML = `
            ${escapeHtml(tag.name)}
            <button type="button"
                    onclick="removeTag('${taskId}', '${tag.id}', this)"
                    class="absolute right-0.5 top-1/2 -translate-y-1/2 h-4 w-4 items-center justify-center rounded-full hover:bg-black/20 hidden group-hover:inline-flex">
                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `;
        tagsList.appendChild(chip);
    }

    // Remove tag from task
    async function removeTag(taskId, tagId, btn) {
        const chip = btn.closest('.tag-chip');
        chip.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/tags/${tagId}`, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('Failed to remove tag');

            chip.remove();

            // Show "No tags" if empty
            const container = document.querySelector('.tags-container');
            const chips = container.querySelectorAll('.tag-chip');
            if (chips.length === 0) {
                const noMsg = document.createElement('p');
                noMsg.className = 'no-tags-msg text-sm text-gray-400 italic mt-2';
                noMsg.textContent = 'No tags';
                container.parentElement.appendChild(noMsg);
            }

            Toastr.success('Tag removed');
        } catch (error) {
            console.error('Error removing tag:', error);
            chip.style.opacity = '1';
            Toastr.error('Failed to remove tag');
        }
    }

    // Close tag dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.add-tag-container')) {
            const dropdowns = document.querySelectorAll('.tag-dropdown');
            dropdowns.forEach(d => d.classList.add('hidden'));
            closeColorPicker();
        }
        if (!e.target.closest('.color-picker-popup') && !e.target.closest('.color-picker-btn')) {
            closeColorPicker();
        }
    });

    // ===== TOGGLE FAVOURITE PROJECT =====
    async function toggleFavourite(projectId, btn) {
        const isFavourite = btn.dataset.isFavourite === 'true';
        const svg = btn.querySelector('svg');

        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/toggle-favourite`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to toggle favourite');

            const data = await response.json();

            if (data.success) {
                // Update favourite buttons on the page for this project
                document.querySelectorAll(`.favourite-btn[data-project-id="${projectId}"]`).forEach(favBtn => {
                    const btnSvg = favBtn.querySelector('svg');
                    favBtn.dataset.isFavourite = data.isFavourite ? 'true' : 'false';

                    if (data.isFavourite) {
                        favBtn.classList.remove('text-gray-300', 'hover:text-yellow-500', 'text-gray-400', 'text-gray-700');
                        favBtn.classList.add('text-yellow-500', 'hover:text-yellow-600');
                        if (!favBtn.closest('#more-menu-dropdown')) favBtn.classList.add('bg-yellow-50');
                        if (btnSvg) btnSvg.setAttribute('fill', 'currentColor');
                        favBtn.title = 'Remove from favourites';
                    } else {
                        favBtn.classList.remove('text-yellow-500', 'hover:text-yellow-600', 'bg-yellow-50');
                        if (favBtn.closest('#more-menu-dropdown')) {
                            favBtn.classList.add('text-gray-700');
                        } else {
                            favBtn.classList.add('text-gray-400', 'hover:text-yellow-500');
                        }
                        if (btnSvg) btnSvg.setAttribute('fill', 'none');
                        favBtn.title = 'Add to favourites';
                    }

                    // Update text label if present (e.g. mobile dropdown)
                    const textNodes = [...favBtn.childNodes].filter(n => n.nodeType === Node.TEXT_NODE || (n.tagName && n.tagName !== 'SVG'));
                    textNodes.forEach(n => {
                        if (n.nodeType === Node.TEXT_NODE && n.textContent.trim()) {
                            n.textContent = data.isFavourite ? ' Unfavourite' : ' Favourite';
                        }
                    });
                });

                if (data.isFavourite) {
                    Toastr.success('Added to favourites');
                    if (data.projectName) {
                        addFavouriteToSidebar(projectId, data.projectName);
                    }
                } else {
                    Toastr.success('Removed from favourites');
                    removeFavouriteFromSidebar(projectId);
                }
            }
        } catch (error) {
            console.error('Error toggling favourite:', error);
            Toastr.error('Failed to update favourite');
        }
    }

    // ===== REMOVE FAVOURITE FROM SIDEBAR =====
    async function removeFavourite(projectId, btn) {
        const item = btn.closest('.favourite-project-item');
        item.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/toggle-favourite`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to remove favourite');

            const data = await response.json();

            if (data.success && !data.isFavourite) {
                // Remove from sidebar with animation
                removeFavouriteFromSidebar(projectId);

                // Update any favourite buttons on the page for this project
                document.querySelectorAll(`.favourite-btn[data-is-favourite="true"]`).forEach(favBtn => {
                    const btnProjectId = favBtn.closest('[data-project-id]')?.dataset.projectId ||
                                         (favBtn.onclick && favBtn.onclick.toString().includes(projectId) ? projectId : null);
                    if (btnProjectId === projectId || favBtn.getAttribute('onclick')?.includes(projectId)) {
                        favBtn.dataset.isFavourite = 'false';
                        favBtn.classList.add('text-gray-300', 'hover:text-yellow-500');
                        favBtn.classList.remove('text-yellow-500', 'hover:text-yellow-600', 'bg-yellow-50');
                        const svg = favBtn.querySelector('svg');
                        if (svg) svg.setAttribute('fill', 'none');
                        favBtn.title = 'Add to favourites';
                    }
                });

                Toastr.success('Removed from favourites');
            }
        } catch (error) {
            console.error('Error removing favourite:', error);
            item.style.opacity = '1';
            Toastr.error('Failed to remove favourite');
        }
    }

    // ===== ADD FAVOURITE TO SIDEBAR =====
    function toggleFavOverflow(btn) {
        const listId = btn.dataset.listId;
        const list = document.getElementById(listId);
        if (!list) return;
        const expanded = btn.dataset.expanded === 'true';
        list.querySelectorAll('.fav-overflow').forEach(el => {
            el.classList.toggle('hidden', expanded);
        });
        btn.dataset.expanded = expanded ? 'false' : 'true';
        if (expanded) {
            const count = list.querySelectorAll('.fav-overflow').length;
            btn.querySelector('.fav-more-text').textContent = count + ' more';
        } else {
            btn.querySelector('.fav-more-text').textContent = 'Show less';
        }
    }

    function updateFavShowMore(listId) {
        const list = document.getElementById(listId);
        if (!list) return;
        const section = list.closest('li[id^="favourite-projects-section"]');
        if (!section) return;
        const items = list.querySelectorAll('.favourite-project-item');
        let showMoreBtn = section.querySelector('.fav-show-more');

        // Reset: mark items beyond 5 as overflow
        items.forEach((item, i) => {
            if (i >= 3) {
                item.classList.add('fav-overflow');
                if (!showMoreBtn || showMoreBtn.dataset.expanded !== 'true') {
                    item.classList.add('hidden');
                }
            } else {
                item.classList.remove('fav-overflow', 'hidden');
            }
        });

        const overflowCount = Math.max(0, items.length - 3);
        if (overflowCount > 0) {
            if (!showMoreBtn) {
                const isGradient = listId.indexOf('classic') === -1;
                const colorClass = isGradient ? 'text-white/50 hover:text-white/80' : 'text-gray-400 hover:text-gray-600';
                showMoreBtn = document.createElement('button');
                showMoreBtn.type = 'button';
                showMoreBtn.className = `fav-show-more -mx-2 mt-1 w-full text-left px-2.5 py-1.5 text-xs font-medium ${colorClass} transition-colors`;
                showMoreBtn.dataset.listId = listId;
                showMoreBtn.onclick = function() { toggleFavOverflow(this); };
                showMoreBtn.innerHTML = '<span class="fav-more-text"></span>';
                list.after(showMoreBtn);
            }
            const textEl = showMoreBtn.querySelector('.fav-more-text');
            if (showMoreBtn.dataset.expanded === 'true') {
                textEl.textContent = 'Show less';
            } else {
                textEl.textContent = overflowCount + ' more';
            }
        } else if (showMoreBtn) {
            showMoreBtn.remove();
        }
    }

    function addFavouriteToSidebar(projectId, projectName) {
        const initial = projectName.charAt(0).toUpperCase();

        // Template for gradient theme
        const gradientHtml = `
            <li class="favourite-project-item group/item overflow-hidden" data-project-id="${projectId}" data-project-name="${projectName}">
                <div class="flex items-center gap-x-1 min-w-0">
                    <a href="${BASE_PATH}/projects/${projectId}"
                       class="text-white/80 hover:bg-white/10 hover:text-white flex-1 min-w-0 flex gap-x-3 rounded-lg p-2.5 text-sm font-semibold leading-6 transition-all">
                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg bg-yellow-500/20 text-[0.625rem] font-medium text-yellow-300 group-hover/item:bg-yellow-500/30">
                            ${initial}
                        </span>
                        <span class="truncate">${projectName}</span>
                    </a>
                    <button type="button"
                            onclick="removeFavourite('${projectId}', this)"
                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-white/50 hover:text-white hover:bg-white/10 transition-all"
                            title="Remove from favourites">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </li>`;

        // Template for classic theme
        const classicHtml = `
            <li class="favourite-project-item group/item overflow-hidden" data-project-id="${projectId}" data-project-name="${projectName}">
                <div class="flex items-center gap-x-1 min-w-0">
                    <a href="${BASE_PATH}/projects/${projectId}"
                       class="text-gray-700 hover:bg-yellow-50 hover:text-yellow-700 flex-1 min-w-0 flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6">
                        <span class="flex h-6 w-6 shrink-0 items-center justify-center rounded-lg border border-yellow-300 bg-yellow-50 text-[0.625rem] font-medium text-yellow-600 group-hover/item:border-yellow-400 group-hover/item:bg-yellow-100">
                            ${initial}
                        </span>
                        <span class="truncate">${projectName}</span>
                    </a>
                    <button type="button"
                            onclick="removeFavourite('${projectId}', this)"
                            class="opacity-0 group-hover/item:opacity-100 p-1.5 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-all"
                            title="Remove from favourites">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </li>`;

        // Add to gradient theme lists
        ['favourite-projects-list', 'favourite-projects-list-mobile'].forEach(listId => {
            const list = document.getElementById(listId);
            if (list && !list.querySelector(`[data-project-id="${projectId}"]`)) {
                list.insertAdjacentHTML('beforeend', gradientHtml);
            }
        });

        // Add to classic theme lists
        ['favourite-projects-list-classic', 'favourite-projects-list-mobile-classic'].forEach(listId => {
            const list = document.getElementById(listId);
            if (list && !list.querySelector(`[data-project-id="${projectId}"]`)) {
                list.insertAdjacentHTML('beforeend', classicHtml);
            }
        });

        // Show sections if hidden
        ['favourite-projects-section', 'favourite-projects-section-mobile', 'favourite-projects-section-classic', 'favourite-projects-section-mobile-classic'].forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
        });

        // Update show more buttons
        ['favourite-projects-list', 'favourite-projects-list-mobile', 'favourite-projects-list-classic', 'favourite-projects-list-mobile-classic'].forEach(updateFavShowMore);
    }

    // ===== REMOVE FAVOURITE FROM SIDEBAR =====
    function removeFavouriteFromSidebar(projectId) {
        document.querySelectorAll(`.favourite-project-item[data-project-id="${projectId}"]`).forEach(el => {
            el.style.transition = 'opacity 0.2s, transform 0.2s, height 0.2s, margin 0.2s, padding 0.2s';
            el.style.opacity = '0';
            el.style.transform = 'translateX(-10px)';
            setTimeout(() => {
                el.style.height = '0';
                el.style.margin = '0';
                el.style.padding = '0';
                el.style.overflow = 'hidden';
                setTimeout(() => {
                    const list = el.parentElement;
                    const listId = list ? list.id : null;
                    el.remove();
                    if (list && list.children.length === 0) {
                        const section = list.closest('[id^="favourite-projects-section"]');
                        if (section) section.classList.add('hidden');
                    }
                    if (listId) updateFavShowMore(listId);
                }, 200);
            }, 200);
        });
    }

    // ===== HIDE RECENT PROJECT =====
    async function hideRecentProject(projectId, btn) {
        const item = btn.closest('.recent-project-item');
        item.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/hide-from-recent`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to hide project');

            // Remove from both desktop and mobile sidebars
            document.querySelectorAll(`.recent-project-item[data-project-id="${projectId}"]`).forEach(el => {
                el.style.transition = 'opacity 0.2s, transform 0.2s, height 0.2s, margin 0.2s, padding 0.2s';
                el.style.opacity = '0';
                el.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    el.style.height = '0';
                    el.style.margin = '0';
                    el.style.padding = '0';
                    el.style.overflow = 'hidden';
                    setTimeout(() => el.remove(), 200);
                }, 200);
            });

            Toastr.success('Removed from recent projects');
        } catch (error) {
            console.error('Error hiding project:', error);
            item.style.opacity = '1';
            Toastr.error('Failed to remove project');
        }
    }

    // ===== HIDE/UNHIDE PROJECTS FROM INDEX =====
    function toggleHiddenProjects() {
        const grid = document.getElementById('hidden-projects-grid');
        const chevron = document.getElementById('hidden-projects-chevron');
        if (grid && chevron) {
            grid.classList.toggle('hidden');
            chevron.classList.toggle('-rotate-90');
        }
    }

    async function hideProject(projectId, btn) {
        const card = btn.closest('[data-project-card]');
        if (!card) return;

        card.style.transition = 'opacity 0.3s, transform 0.3s';
        card.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/hide`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to hide project');
            }

            const data = await response.json();

            if (data.success) {
                // Animate card removal
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    card.remove();

                    // Remove from favourites sidebar
                    removeFavouriteFromSidebar(projectId);

                    // Remove from recent projects sidebar
                    document.querySelectorAll(`.recent-project-item[data-project-id="${projectId}"]`).forEach(el => {
                        el.style.transition = 'opacity 0.2s, transform 0.2s, height 0.2s, margin 0.2s, padding 0.2s';
                        el.style.opacity = '0';
                        el.style.transform = 'translateX(-10px)';
                        setTimeout(() => {
                            el.style.height = '0';
                            el.style.margin = '0';
                            el.style.padding = '0';
                            el.style.overflow = 'hidden';
                            setTimeout(() => el.remove(), 200);
                        }, 200);
                    });

                    // Reload page to show hidden projects section
                    window.location.reload();
                }, 300);

                Toastr.success(`"${data.projectName}" hidden`);
            }
        } catch (error) {
            console.error('Error hiding project:', error);
            card.style.opacity = '1';
            card.style.transform = '';
            Toastr.error(error.message || 'Failed to hide project');
        }
    }

    async function unhideProject(projectId, btn) {
        const card = btn.closest('[data-project-card]');
        if (!card) return;

        card.style.transition = 'opacity 0.3s, transform 0.3s';
        card.style.opacity = '0.5';

        try {
            const response = await fetch(`${BASE_PATH}/projects/${projectId}/unhide`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) throw new Error('Failed to unhide project');

            const data = await response.json();

            if (data.success) {
                // Reload page to show project in main list
                Toastr.success(`"${data.projectName}" restored`);
                window.location.reload();
            }
        } catch (error) {
            console.error('Error unhiding project:', error);
            card.style.opacity = '1';
            card.style.transform = '';
            Toastr.error('Failed to unhide project');
        }
    }

    // ===== DETAIL PAGE TAB FUNCTIONS =====
    function switchDetailTab(tabName, btn) {
        // Update button states
        const container = btn.closest('.task-detail-tabs');
        container.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active', 'text-gray-700', 'border-primary-500');
            b.classList.add('text-gray-500', 'border-transparent');
        });
        btn.classList.add('active', 'text-gray-700', 'border-primary-500');
        btn.classList.remove('text-gray-500', 'border-transparent');

        // Show/hide tab content
        container.querySelectorAll('.detail-tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById('detail-tab-' + tabName).classList.remove('hidden');
    }

    // Trigger Vue ActivityLog component to load
    function triggerVueActivityLoad() {
        // Dispatch custom event that Vue component listens for
        document.dispatchEvent(new CustomEvent('load-activity'));
    }

    // ===== ACTIVITY TAB FUNCTIONS =====
    async function loadActivityTab(taskId) {
        // For panel: find activity container in the tab
        const activityTab = document.getElementById('tab-activity');
        if (!activityTab) return;

        const container = activityTab.querySelector('.activity-container');
        if (container) {
            await loadActivityForContainer(container);
        }
    }

    async function loadActivityForContainer(container) {
        if (!container) return;

        // Only load once
        if (container.dataset.loaded === 'true') return;

        const taskId = container.dataset.taskId;
        const loadingEl = container.querySelector('.activity-loading');
        const listEl = container.querySelector('.activity-list');
        const noActivityEl = container.querySelector('.no-activity-msg');

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/activity`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) throw new Error('Failed to load activity');

            const data = await response.json();
            const activities = data.activities;

            loadingEl.classList.add('hidden');

            if (activities.length === 0) {
                noActivityEl.classList.remove('hidden');
            } else {
                listEl.innerHTML = activities.map(activity => formatActivityItem(activity)).join('');
                listEl.classList.remove('hidden');
            }

            container.dataset.loaded = 'true';
        } catch (error) {
            console.error('Error loading activity:', error);
            loadingEl.innerHTML = '<p class="text-sm text-red-500">Failed to load activity</p>';
        }
    }

    function formatActivityItem(activity) {
        const icon = getActivityIcon(activity.action);
        const description = formatActivityDescription(activity);

        return `
            <div class="activity-item flex gap-3 py-2">
                <div class="flex-shrink-0">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-gray-100">
                        ${icon}
                    </span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-900">
                        <span class="font-medium">${escapeHtml(activity.user.fullName)}</span>
                        <span class="text-gray-600">${description}</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-0.5">${activity.createdAt}</p>
                </div>
            </div>
        `;
    }

    function getActivityIcon(action) {
        const icons = {
            'created': '<svg class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>',
            'status_changed': '<svg class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>',
            'priority_changed': '<svg class="h-4 w-4 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21l3.75-3.75" /></svg>',
            'milestone_changed': '<svg class="h-4 w-4 text-purple-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0l2.77-.693a9 9 0 016.208.682l.108.054a9 9 0 006.086.71l3.114-.732a48.524 48.524 0 01-.005-10.499l-3.11.732a9 9 0 01-6.085-.711l-.108-.054a9 9 0 00-6.208-.682L3 4.5M3 15V4.5" /></svg>',
            'assigned': '<svg class="h-4 w-4 text-primary-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg>',
            'unassigned': '<svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M22 10.5h-6m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg>',
            'commented': '<svg class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>',
            'updated': '<svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>',
        };
        return icons[action] || icons['updated'];
    }

    function formatActivityDescription(activity) {
        const action = activity.action;
        const metadata = activity.metadata || {};

        switch (action) {
            case 'created':
                return ' created this task';
            case 'status_changed':
                return ` changed status from <span class="font-medium">${escapeHtml(metadata.from || '')}</span> to <span class="font-medium">${escapeHtml(metadata.to || '')}</span>`;
            case 'priority_changed':
                return ` changed priority from <span class="font-medium">${escapeHtml(metadata.from || '')}</span> to <span class="font-medium">${escapeHtml(metadata.to || '')}</span>`;
            case 'milestone_changed':
                return ` moved to milestone <span class="font-medium">${escapeHtml(metadata.to || '')}</span>`;
            case 'assigned':
                return ` assigned <span class="font-medium">${escapeHtml(metadata.assignee || '')}</span>`;
            case 'unassigned':
                return ` unassigned <span class="font-medium">${escapeHtml(metadata.assignee || '')}</span>`;
            case 'commented':
                return ' added a comment';
            case 'updated':
                return formatUpdatedDescription(metadata);
            default:
                return ` ${activity.actionLabel}`;
        }
    }

    function formatUpdatedDescription(metadata) {
        const changes = metadata.changes || {};

        if (changes.title) {
            return ` changed title from <span class="font-medium">${escapeHtml(changes.title.from || '')}</span> to <span class="font-medium">${escapeHtml(changes.title.to || '')}</span>`;
        }
        if (changes.dueDate) {
            const from = changes.dueDate.from || 'none';
            const to = changes.dueDate.to || 'none';
            return ` changed due date from <span class="font-medium">${escapeHtml(from)}</span> to <span class="font-medium">${escapeHtml(to)}</span>`;
        }
        if (changes.startDate) {
            const from = changes.startDate.from || 'none';
            const to = changes.startDate.to || 'none';
            return ` changed start date from <span class="font-medium">${escapeHtml(from)}</span> to <span class="font-medium">${escapeHtml(to)}</span>`;
        }
        return ' updated this task';
    }

    // ===== RECURRENCE FUNCTIONS =====
    window.currentRecurrenceTaskId = null;

    function openRecurrenceModal(taskId) {
        currentRecurrenceTaskId = taskId;
        const modal = document.getElementById('recurrence-modal');
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        // Load current recurrence settings
        loadRecurrenceInfo(taskId);
    }

    function closeRecurrenceModal() {
        const modal = document.getElementById('recurrence-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        currentRecurrenceTaskId = null;
        resetRecurrenceForm();
    }

    function resetRecurrenceForm() {
        document.getElementById('recurrence-frequency').value = '';
        document.getElementById('recurrence-interval').value = '1';
        document.getElementById('recurrence-weekdays-only').checked = false;
        document.querySelectorAll('.weekday-btn input').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="monthly-type"]')[0].checked = true;
        document.querySelectorAll('input[name="end-type"]')[0].checked = true;
        document.getElementById('recurrence-end-date').value = '';
        document.getElementById('recurrence-count').value = '10';
        document.getElementById('remove-recurrence-btn').classList.add('hidden');
        updateRecurrenceOptions();
    }

    async function loadRecurrenceInfo(taskId) {
        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/recurrence/info`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) return;

            const data = await response.json();
            if (data.isRecurring && data.recurrence) {
                const rule = data.recurrence.rule;
                document.getElementById('recurrence-frequency').value = rule.frequency || '';
                document.getElementById('recurrence-interval').value = rule.interval || 1;

                if (rule.weekdaysOnly) {
                    document.getElementById('recurrence-weekdays-only').checked = true;
                }

                if (rule.weekDays) {
                    document.querySelectorAll('.weekday-btn input').forEach(cb => {
                        cb.checked = rule.weekDays.includes(parseInt(cb.value));
                    });
                }

                if (rule.monthlyType === 'dayOfWeek') {
                    document.querySelectorAll('input[name="monthly-type"]')[1].checked = true;
                    document.getElementById('monthly-week-of-month').value = rule.weekOfMonth || 1;
                    document.getElementById('monthly-day-of-week').value = rule.dayOfWeek || 1;
                }

                if (data.recurrence.endsAt) {
                    document.querySelectorAll('input[name="end-type"]')[1].checked = true;
                    document.getElementById('recurrence-end-date').value = data.recurrence.endsAt;
                } else if (data.recurrence.countRemaining) {
                    document.querySelectorAll('input[name="end-type"]')[2].checked = true;
                    document.getElementById('recurrence-count').value = data.recurrence.countRemaining;
                }

                document.getElementById('remove-recurrence-btn').classList.remove('hidden');
                updateRecurrenceOptions();
            }
        } catch (error) {
            console.error('Error loading recurrence info:', error);
        }
    }

    function updateRecurrenceOptions() {
        const frequency = document.getElementById('recurrence-frequency').value;
        const intervalContainer = document.getElementById('recurrence-interval-container');
        const intervalLabel = document.getElementById('recurrence-interval-label');
        const weekdaysContainer = document.getElementById('recurrence-weekdays-container');
        const weekdaysSelect = document.getElementById('recurrence-weekdays-select');
        const monthlyContainer = document.getElementById('recurrence-monthly-container');
        const endContainer = document.getElementById('recurrence-end-container');

        // Hide all optional sections
        intervalContainer.classList.add('hidden');
        weekdaysContainer.classList.add('hidden');
        weekdaysSelect.classList.add('hidden');
        monthlyContainer.classList.add('hidden');
        endContainer.classList.add('hidden');

        if (!frequency) return;

        // Show interval and end options for all frequencies
        intervalContainer.classList.remove('hidden');
        endContainer.classList.remove('hidden');

        // Update interval label based on frequency
        const labels = {
            daily: 'days',
            weekly: 'weeks',
            monthly: 'months',
            quarterly: 'quarters',
            yearly: 'years'
        };
        intervalLabel.textContent = labels[frequency] || 'periods';

        // Show frequency-specific options
        if (frequency === 'daily') {
            weekdaysContainer.classList.remove('hidden');
        } else if (frequency === 'weekly') {
            weekdaysSelect.classList.remove('hidden');
        } else if (frequency === 'monthly') {
            monthlyContainer.classList.remove('hidden');
        }

        // Update weekday button styles
        document.querySelectorAll('.weekday-btn input').forEach(cb => {
            const span = cb.nextElementSibling;
            if (cb.checked) {
                span.classList.add('bg-primary-600', 'text-white', 'border-primary-600');
                span.classList.remove('border-gray-300');
            } else {
                span.classList.remove('bg-primary-600', 'text-white', 'border-primary-600');
                span.classList.add('border-gray-300');
            }
        });
    }

    // Add event listeners for weekday buttons
    document.addEventListener('change', function(e) {
        if (e.target.closest('.weekday-btn')) {
            updateRecurrenceOptions();
        }
    });

    // Handle monthly type change
    document.addEventListener('change', function(e) {
        if (e.target.name === 'monthly-type') {
            const dowOptions = document.getElementById('monthly-dow-options');
            if (e.target.value === 'dayOfWeek') {
                dowOptions.classList.remove('hidden');
            } else {
                dowOptions.classList.add('hidden');
            }
        }
    });

    // Handle end type change
    document.addEventListener('change', function(e) {
        if (e.target.name === 'end-type') {
            const endDate = document.getElementById('recurrence-end-date');
            const endCount = document.getElementById('recurrence-count');
            endDate.disabled = e.target.value !== 'date';
            endCount.disabled = e.target.value !== 'count';
        }
    });

    async function saveRecurrence() {
        const taskId = currentRecurrenceTaskId;
        if (!taskId) return;

        const frequency = document.getElementById('recurrence-frequency').value;

        if (!frequency) {
            // Remove recurrence
            await removeRecurrence();
            return;
        }

        const data = {
            frequency: frequency,
            interval: parseInt(document.getElementById('recurrence-interval').value) || 1
        };

        // Daily options
        if (frequency === 'daily') {
            data.weekdaysOnly = document.getElementById('recurrence-weekdays-only').checked;
        }

        // Weekly options
        if (frequency === 'weekly') {
            const weekDays = [];
            document.querySelectorAll('.weekday-btn input:checked').forEach(cb => {
                weekDays.push(parseInt(cb.value));
            });
            if (weekDays.length > 0) {
                data.weekDays = weekDays;
            }
        }

        // Monthly options
        if (frequency === 'monthly') {
            const monthlyType = document.querySelector('input[name="monthly-type"]:checked').value;
            data.monthlyType = monthlyType;
            if (monthlyType === 'dayOfWeek') {
                data.weekOfMonth = parseInt(document.getElementById('monthly-week-of-month').value);
                data.dayOfWeek = parseInt(document.getElementById('monthly-day-of-week').value);
            }
        }

        // End conditions
        const endType = document.querySelector('input[name="end-type"]:checked').value;
        if (endType === 'date') {
            const endDate = document.getElementById('recurrence-end-date').value;
            if (endDate) {
                data.endsAt = endDate;
            }
        } else if (endType === 'count') {
            const count = parseInt(document.getElementById('recurrence-count').value);
            if (count > 0) {
                data.count = Math.min(count, 52);
            }
        }

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/recurrence`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                Toastr.error(errorData.error || 'Failed to set recurrence');
                return;
            }

            const result = await response.json();
            closeRecurrenceModal();
            Toastr.success('Recurrence set');

            // Update the recurrence label in the panel
            updateRecurrenceLabel(taskId, result.recurrence.description);

            // Notify other components
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'recurrence', value: result.recurrence }
            }));
        } catch (error) {
            console.error('Error saving recurrence:', error);
            Toastr.error('Failed to set recurrence');
        }
    }

    async function removeRecurrence() {
        const taskId = currentRecurrenceTaskId;
        if (!taskId) return;

        try {
            const response = await fetch(`${BASE_PATH}/tasks/${taskId}/recurrence`, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!response.ok) {
                Toastr.error('Failed to remove recurrence');
                return;
            }

            closeRecurrenceModal();
            Toastr.success('Recurrence removed');

            // Update the recurrence label in the panel
            updateRecurrenceLabel(taskId, 'Does not repeat');

            // Notify other components
            document.dispatchEvent(new CustomEvent('task-updated', {
                detail: { taskId, field: 'recurrence', value: null }
            }));
        } catch (error) {
            console.error('Error removing recurrence:', error);
            Toastr.error('Failed to remove recurrence');
        }
    }

    function updateRecurrenceLabel(taskId, description) {
        const container = document.querySelector(`.recurrence-container[data-task-id="${taskId}"]`);
        if (container) {
            const label = container.querySelector('.recurrence-label');
            if (label) {
                label.textContent = description;
            }
            const btn = container.querySelector('.recurrence-btn');
            const icon = btn.querySelector('svg');
            if (description !== 'Does not repeat') {
                btn.classList.add('text-primary-600');
                btn.classList.remove('text-gray-900');
                icon.classList.add('text-primary-500');
                icon.classList.remove('text-gray-400');
            } else {
                btn.classList.remove('text-primary-600');
                btn.classList.add('text-gray-900');
                icon.classList.remove('text-primary-500');
                icon.classList.add('text-gray-400');
            }
        }
    }

    // Global notification function
    window.showNotification = function(message, type = 'success') {
        const flashContainer = document.querySelector('.px-4.sm\\:px-6.lg\\:px-8');
        if (!flashContainer) return;

        const colors = {
            success: { bg: 'bg-green-50', text: 'text-green-800', icon: 'text-green-400', hover: 'text-green-500 hover:bg-green-100' },
            error: { bg: 'bg-red-50', text: 'text-red-800', icon: 'text-red-400', hover: 'text-red-500 hover:bg-red-100' },
            warning: { bg: 'bg-yellow-50', text: 'text-yellow-800', icon: 'text-yellow-400', hover: 'text-yellow-500 hover:bg-yellow-100' },
            info: { bg: 'bg-blue-50', text: 'text-blue-800', icon: 'text-blue-400', hover: 'text-blue-500 hover:bg-blue-100' }
        };

        const color = colors[type] || colors.info;

        const icons = {
            success: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />',
            error: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />',
            warning: '<path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />',
            info: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />'
        };

        const icon = icons[type] || icons.info;

        const flashDiv = document.createElement('div');
        flashDiv.className = `mb-4 rounded-md p-4 ${color.bg}`;
        flashDiv.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 ${color.icon}" viewBox="0 0 20 20" fill="currentColor">
                        ${icon}
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm font-medium ${color.text}">${message}</p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" class="-m-1.5 inline-flex rounded-md p-1.5 ${color.hover}" onclick="this.closest('.mb-4').remove()">
                        <span class="sr-only">Dismiss</span>
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

        flashContainer.insertBefore(flashDiv, flashContainer.firstChild);

        setTimeout(() => {
            flashDiv.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => flashDiv.remove(), 300);
        }, 5000);
    };
    </script>
</div>
{% endblock %}

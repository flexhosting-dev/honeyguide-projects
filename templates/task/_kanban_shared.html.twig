{#
   Shared Kanban Board Component - Vue-powered
   Variables:
   - tasks: Task[] (flat list of all tasks)
   - milestones: list of Milestone entities
   - kanbanModeKey: localStorage key for mode persistence
#}

{% set kanbanModeKey = kanbanModeKey|default('kanban_mode') %}
{% set milestones = milestones|default([]) %}
{% set basePath = app.request.basePath %}

<div
    data-vue-component="KanbanBoard"
    data-vue-initial-tasks='{{ tasks|map(task => {
        id: task.id ~ '',
        title: task.title,
        status: { value: task.status.value, label: task.status.label },
        priority: { value: task.priority.value, label: task.priority.label },
        milestoneId: task.milestone ? task.milestone.id ~ '' : null,
        projectName: task.project.name,
        dueDate: task.dueDate ? task.dueDate|date('Y-m-d') : null,
        position: task.position,
        depth: task.depth|default(0),
        commentCount: task.commentCount|default(0),
        checklistCount: task.checklistCount|default(0),
        completedChecklistCount: task.completedChecklistCount|default(0),
        assignees: task.assignees|map(a => {
            id: a.id ~ '',
            user: {
                id: a.user.id ~ '',
                firstName: a.user.firstName,
                lastName: a.user.lastName,
                fullName: a.user.fullName,
                avatar: a.user.avatar ? basePath ~ '/uploads/avatars/' ~ a.user.avatar : null
            }
        }),
        tags: task.tags|map(t => {
            id: t.id ~ '',
            name: t.name,
            color: t.color
        }),
        subtaskCount: task.subtaskCount|default(0),
        completedSubtaskCount: task.completedSubtaskCount|default(0),
        parentId: task.parent ? task.parent.id ~ '' : null,
        parentChain: task.parentChain
    })|json_encode|e('html_attr') }}'
    data-vue-milestones='{{ milestones|map(m => {
        id: m.id ~ '',
        name: m.name,
        dueDate: m.dueDate ? m.dueDate|date('Y-m-d') : null
    })|json_encode|e('html_attr') }}'
    data-vue-mode-storage-key="{{ kanbanModeKey }}"
    data-vue-base-path="{{ basePath }}"
    data-vue-status-url-template="{{ path('app_task_update_status', {id: '__TASK_ID__'}) }}"
    data-vue-priority-url-template="{{ path('app_task_update_priority', {id: '__TASK_ID__'}) }}"
    data-vue-milestone-url-template="{{ path('app_task_update_milestone', {id: '__TASK_ID__'}) }}"
    data-vue-reorder-url="{{ path('app_task_reorder') }}"
    data-vue-project-id="{{ project.id|default('') }}"
    data-vue-create-url="{{ project is defined ? path('app_task_create_json', {projectId: project.id}) : '' }}"
    data-vue-members-url="{{ project is defined ? path('app_project_members_list', {projectId: project.id}) : '' }}"
    data-vue-assign-url-template="{{ path('app_task_update_assignees', {id: '__TASK_ID__'}) }}"
    data-vue-subtask-url-template="{{ path('app_task_create_subtask', {id: '__TASK_ID__'}) }}"
>
    {# Loading fallback shown before Vue mounts #}
    <div class="flex items-center justify-center py-12">
        <svg class="animate-spin h-8 w-8 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="ml-3 text-gray-500">Loading kanban board...</span>
    </div>
</div>

<style>
/* ===== Drop placeholder ===== */
.drop-placeholder {
    background: #f9fafb;
    border: 1px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 1.25rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 70px;
}
.drop-placeholder span { color: #9ca3af; font-size: 0.8125rem; }

/* ===== Grid ===== */
.kanban-grid.hidden { display: none !important; }
.kanban-grid {
    display: flex;
    gap: 1rem;
    align-items: stretch;
    min-height: 500px;
    max-height: 70vh;
    overflow-x: auto;
    overflow-y: hidden;
    padding-bottom: 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: #d1d5db #f3f4f6;
}
.kanban-grid::-webkit-scrollbar { height: 8px; }
.kanban-grid::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 4px; }
.kanban-grid::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }

/* ===== Column ===== */
.kanban-col {
    flex: 0 0 calc((100% - 3rem) / 4);
    min-width: 280px;
    max-width: calc((100% - 3rem) / 4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: flex 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, padding 0.3s ease, overflow 0s 0.3s;
    padding: 1rem;
    position: relative;
}
.kanban-col.collapsed {
    overflow: visible;
    transition: flex 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, padding 0.3s ease, overflow 0s;
}
.kb-milestone-col {
    flex: 0 0 calc((100% - 3rem) / 4);
    min-width: 280px;
    max-width: calc((100% - 3rem) / 4);
}

/* --- Toggle button --- */
.kanban-toggle-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 2;
    padding: 0.25rem;
    border-radius: 0.375rem;
    color: #6b7280;
    cursor: pointer;
    background: none;
    border: none;
    transition: transform 0.3s ease, color 0.15s ease;
}
.kanban-toggle-btn:hover { color: #374151; background: rgba(0,0,0,0.06); }

/* --- Badge wrap --- */
.kanban-badge-wrap {
    margin-bottom: 0.75rem;
    transition: transform 0.3s ease, margin 0.3s ease;
    transform-origin: top left;
    flex-shrink: 0;
}
.kanban-badge {
    display: inline-flex;
    align-items: center;
    border-radius: 9999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: white;
    white-space: nowrap;
}

/* --- Body --- */
.kanban-body {
    flex: 1;
    overflow-y: auto;
    opacity: 1;
    transition: opacity 0.3s ease;
    scrollbar-width: thin;
    scrollbar-color: #d1d5db transparent;
}
.kanban-body::-webkit-scrollbar { width: 6px; }
.kanban-body::-webkit-scrollbar-track { background: transparent; }
.kanban-body::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
.kanban-dropzone { display: flex; flex-direction: column; gap: 0.75rem; min-height: 60px; }

/* ===== DESKTOP: Horizontal collapse ===== */
@media (min-width: 1024px) {
    .kanban-col.collapsed {
        flex: 0 0 52px;
        min-width: 52px;
        max-width: 52px;
        padding: 0.75rem 0.25rem;
        cursor: pointer;
        overflow: visible;
        border-radius: 0.5rem;
    }
    /* Rotate chevron only — button stays at top-right */
    .kanban-col.collapsed .kanban-toggle-btn {
        transform: rotate(180deg);
        position: static;
        margin: 0 auto;
        display: block;
    }
    /* Rotate badge vertically */
    .kanban-col.collapsed .kanban-badge-wrap {
        margin: 0.5rem auto 0;
        overflow: visible;
    }
    .kanban-col.collapsed .kanban-badge {
        white-space: nowrap;
        transform: rotate(180deg);
        writing-mode: vertical-rl;
        text-orientation: mixed;
        padding: 0.75rem 0.25rem;
        font-size: 0.75rem;
    }
    /* Hide body */
    .kanban-col.collapsed .kanban-body {
        display: none;
    }
}

/* ===== MOBILE: Vertical collapse ===== */
@media (max-width: 1023px) {
    .kanban-grid {
        flex-direction: column;
        max-height: none;
        overflow-x: hidden;
        overflow-y: auto;
    }
    .kanban-col,
    .kb-milestone-col {
        flex: none !important;
        min-width: 100% !important;
        max-width: 100% !important;
        transition: max-height 0.3s ease, padding 0.3s ease;
        max-height: 800px; /* generous max for animation */
    }
    .kanban-body { max-height: 300px; }

    /* Collapsed: shrink to header-only height */
    .kanban-col.collapsed {
        max-height: 52px;
        padding: 0.75rem 1rem;
        overflow: hidden;
    }
    /* Rotate toggle chevron 90° to point down→up */
    .kanban-toggle-btn {
        transition: transform 0.3s ease, color 0.15s ease;
    }
    .kanban-col .kanban-toggle-btn {
        transform: rotate(-90deg); /* points up = expanded */
    }
    .kanban-col.collapsed .kanban-toggle-btn {
        transform: rotate(90deg); /* points down = collapsed */
    }
    .kanban-col.collapsed .kanban-badge-wrap {
        display: inline-flex;
        margin: 0;
    }
    .kanban-col.collapsed .kanban-body {
        opacity: 0;
        pointer-events: none;
    }
}

/* ===== Badge color classes ===== */
.kb-badge-gray   { background-color: #6b7280; }
.kb-badge-blue   { background-color: #3b82f6; }
.kb-badge-yellow { background-color: #eab308; }
.kb-badge-green  { background-color: #22c55e; }
.kb-badge-red    { background-color: #ef4444; }
.kb-badge-indigo { background-color: #6366f1; }
.kb-badge-purple { background-color: #a855f7; }
.kb-badge-pink   { background-color: #ec4899; }
.kb-badge-teal   { background-color: #14b8a6; }
.kb-badge-orange { background-color: #f97316; }
.kb-badge-cyan   { background-color: #06b6d4; }

/* ===== Column background color classes ===== */
.kb-bg-gray   { background-color: #f3f4f6; }
.kb-bg-blue   { background-color: #eff6ff; }
.kb-bg-yellow { background-color: #fefce8; }
.kb-bg-green  { background-color: #f0fdf4; }
.kb-bg-red    { background-color: #fef2f2; }
.kb-bg-indigo { background-color: #eef2ff; }
.kb-bg-purple { background-color: #faf5ff; }
.kb-bg-pink   { background-color: #fdf2f8; }
.kb-bg-teal   { background-color: #f0fdfa; }
.kb-bg-orange { background-color: #fff7ed; }
.kb-bg-cyan   { background-color: #ecfeff; }

/* Quick-add button in column header */
.kanban-col.collapsed .kanban-col-add-btn { display: none; }

/* Show subtask add button on card hover */
.task-card:hover .task-card-add-subtask { opacity: 1; }
</style>

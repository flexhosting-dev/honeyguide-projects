{#
   Task Page Component - Shared partial for task views

   Variables:
   - pageTitle: string (optional, for header display)
   - pageDescription: string (optional)
   - formAction: string (route name for filter form submission)
   - formActionParams: array (optional route parameters)
   - tasks: Task[] (all filtered tasks)
   - tasksByStatus: array (tasks grouped by status for kanban)
   - filter: TaskFilterDTO
   - userProjects: Project[] (for project filter dropdown)
   - projectMembers: User[] (for assignee filter dropdown)
   - showProjectFilter: bool (false for project tasks page)
   - storageKey: string (localStorage key for view persistence)
   - project: Project (optional, for project-specific context)
   - showHeader: bool (default true, whether to show page header)
   - showAddButton: bool (default false, whether to show add task button)
#}
{% set formActionParams = formActionParams|default({}) %}
{% set showHeader = showHeader|default(true) %}
{% set showAddButton = showAddButton|default(false) %}
{% set storageKey = storageKey|default('task_view') %}

<div class="space-y-4" id="task-page-container" data-storage-key="{{ storageKey }}">
    {# Page Header (optional) #}
    {% if showHeader and pageTitle is defined %}
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-xl font-semibold text-gray-900">{{ pageTitle }}</h1>
            {% if pageDescription is defined and pageDescription %}
                <p class="mt-2 text-sm text-gray-700">{{ pageDescription }}</p>
            {% endif %}
        </div>
        {% if showAddButton and project is defined and project.milestones|length > 0 %}
        <div class="mt-3 sm:mt-0">
            <button type="button"
                    onclick="openTaskCreatePanel('{{ project.id }}')"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Task
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Filter Bar #}
    {% include 'task/_filters.html.twig' with {
        formAction: formAction,
        formActionParams: formActionParams,
        filter: filter,
        userProjects: userProjects,
        projectMembers: projectMembers,
        showProjectFilter: showProjectFilter,
        tasks: tasks
    } %}

    {% if tasks|length > 0 %}
        {# View Toggle #}
        <div class="flex items-center justify-between">
            <div class="inline-flex rounded-lg bg-gray-100 p-1">
                <button type="button" onclick="showTaskView(0)" id="task-view-btn-0"
                        class="task-view-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-white text-primary-600 shadow-sm">
                    <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                    </svg>
                    List
                </button>
                <button type="button" onclick="showTaskView(1)" id="task-view-btn-1"
                        class="task-view-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                    <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125Z" />
                    </svg>
                    Kanban
                </button>
            </div>
            {% if showAddButton and project is defined and project.milestones|length > 0 %}
            <button type="button"
                    onclick="openTaskCreatePanel('{{ project.id }}')"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Task
            </button>
            {% elseif showAddButton and project is defined and project.milestones|length == 0 %}
            <a href="{{ path('app_milestone_new', {projectId: project.id}) }}"
               class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Milestone First
            </a>
            {% endif %}
        </div>

        {# List View #}
        <div id="task-view-panel-0" class="task-view-panel">
            {% include 'task/_list.html.twig' with {
                tasks: tasks,
                project: project|default(null)
            } %}
        </div>

        {# Kanban View #}
        <div id="task-view-panel-1" class="task-view-panel hidden">
            {% include 'task/_kanban_shared.html.twig' with {
                tasks: tasks,
                milestones: milestones|default([]),
                kanbanModeKey: kanbanModeKey|default('kanban_mode')
            } %}
        </div>
    {% else %}
        {% include 'components/_empty_state.html.twig' with {
            icon: 'task',
            title: filter.hasActiveFilters ? 'No tasks match your filters' : 'No tasks yet',
            description: filter.hasActiveFilters ? 'Try adjusting your filters or clear them to see all tasks.' : 'Tasks will appear here once they are created.'
        } %}
    {% endif %}
</div>

<script>
(function() {
    const container = document.getElementById('task-page-container');
    if (!container) return;

    const storageKey = container.dataset.storageKey;

    window.showTaskView = function(index, save = true) {
        // Update view buttons
        document.querySelectorAll('.task-view-btn').forEach((btn, i) => {
            if (i === index) {
                btn.classList.remove('text-gray-600', 'hover:text-gray-900');
                btn.classList.add('bg-white', 'text-primary-600', 'shadow-sm');
            } else {
                btn.classList.remove('bg-white', 'text-primary-600', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:text-gray-900');
            }
        });

        // Update view panels
        document.querySelectorAll('.task-view-panel').forEach((panel, i) => {
            if (i === index) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        });

        // Save to localStorage
        if (save && storageKey) {
            try {
                localStorage.setItem(storageKey, index);
            } catch (e) {
                // Ignore storage errors
            }
        }
    };

    // Restore saved view on load
    if (storageKey) {
        try {
            const savedView = localStorage.getItem(storageKey);
            if (savedView !== null) {
                showTaskView(parseInt(savedView), false);
            }
        } catch (e) {
            // Ignore storage errors
        }
    }
})();
</script>

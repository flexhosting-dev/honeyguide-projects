{#
   Task Page Component - Shared partial for task views

   Variables:
   - pageTitle: string (optional, for header display)
   - pageDescription: string (optional)
   - formAction: string (route name for filter form submission)
   - formActionParams: array (optional route parameters)
   - tasks: Task[] (all filtered tasks)
   - tasksByStatus: array (tasks grouped by status for kanban)
   - filter: TaskFilterDTO
   - userProjects: Project[] (for project filter dropdown)
   - projectMembers: User[] (for assignee filter dropdown)
   - showProjectFilter: bool (false for project tasks page)
   - storageKey: string (localStorage key for view persistence)
   - project: Project (optional, for project-specific context)
   - showHeader: bool (default true, whether to show page header)
   - showAddButton: bool (default false, whether to show add task button)
#}
{% set formActionParams = formActionParams|default({}) %}
{% set showHeader = showHeader|default(true) %}
{% set showAddButton = showAddButton|default(false) %}
{% set storageKey = storageKey|default('task_view') %}

<div class="space-y-4" id="task-page-container" data-storage-key="{{ storageKey }}">
    {# Page Header (optional) #}
    {% if showHeader and pageTitle is defined %}
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-xl font-semibold text-gray-900">{{ pageTitle }}</h1>
            {% if pageDescription is defined and pageDescription %}
                <p class="mt-2 text-sm text-gray-700">{{ pageDescription }}</p>
            {% endif %}
        </div>
        {% if showAddButton and canCreateTask|default(false) and project is defined and project.milestones|length > 0 %}
        <div class="mt-3 sm:mt-0">
            <button type="button"
                    onclick="openTaskCreatePanel('{{ project.id }}', true, {{ autoAssignNewTasks|default(false) ? 'true' : 'false' }})"
                    class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Task
            </button>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# Filter Bar #}
    {% include 'task/_filters.html.twig' with {
        formAction: formAction,
        formActionParams: formActionParams,
        filter: filter,
        userProjects: userProjects,
        projectMembers: projectMembers,
        showProjectFilter: showProjectFilter,
        tasks: tasks
    } %}

    {% if tasks|length > 0 %}
        {# View Toggle #}
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="inline-flex rounded-lg bg-gray-100 p-1">
                    <button type="button" onclick="showTaskView(0)" id="task-view-btn-0"
                            class="task-view-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-white text-primary-600 shadow-sm">
                        <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
                        </svg>
                        Table
                    </button>
                    <button type="button" onclick="showTaskView(1)" id="task-view-btn-1"
                            class="task-view-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125Z" />
                        </svg>
                        Kanban
                    </button>
                    <button type="button" onclick="showTaskView(2)" id="task-view-btn-2"
                            class="task-view-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900">
                        <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                        </svg>
                        Gantt
                    </button>
                </div>

                {# Kanban Mode Switcher - desktop: inline tabs, mobile: dropdown #}
                <div id="kanban-mode-switcher" class="hidden mr-3">
                    {# Desktop: inline pill tabs #}
                    <div class="hidden md:inline-flex rounded-lg bg-gray-100 p-1">
                        <button type="button" onclick="setKanbanMode('status')"
                                class="kanban-mode-ext-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md bg-white text-primary-600 shadow-sm"
                                data-mode="status">
                            Status
                        </button>
                        <button type="button" onclick="setKanbanMode('priority')"
                                class="kanban-mode-ext-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900"
                                data-mode="priority">
                            Priority
                        </button>
                        <button type="button" onclick="setKanbanMode('milestone')"
                                class="kanban-mode-ext-btn inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900"
                                data-mode="milestone" style="display:none;">
                            Milestone
                        </button>
                    </div>
                    {# Mobile: dropdown select - styled to match view switcher #}
                    <div class="md:hidden inline-flex rounded-lg bg-gray-100 p-1">
                        <select id="kanban-mode-select" onchange="setKanbanMode(this.value)"
                                class="appearance-none bg-white text-primary-600 shadow-sm rounded-md text-sm font-medium py-1.5 pl-3 pr-8 border-0 focus:ring-2 focus:ring-primary-500 cursor-pointer"
                                style="background-image: url('data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 fill=%27none%27 viewBox=%270 0 24 24%27 stroke=%27%234f46e5%27 stroke-width=%272%27%3E%3Cpath stroke-linecap=%27round%27 stroke-linejoin=%27round%27 d=%27M19 9l-7 7-7-7%27/%3E%3C/svg%3E'); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1rem;">
                            <option value="status">Status</option>
                            <option value="priority">Priority</option>
                            <option value="milestone" id="kanban-mode-milestone-option" style="display:none;">Milestone</option>
                        </select>
                    </div>
                </div>
            </div>
            {% if showAddButton and canCreateTask|default(false) and project is defined and project.milestones|length > 0 %}
            <button type="button"
                    onclick="openTaskCreatePanel('{{ project.id }}', true, {{ autoAssignNewTasks|default(false) ? 'true' : 'false' }})"
                    title="New Task"
                    class="inline-flex items-center rounded-md bg-primary-600 px-2.5 py-2 sm:px-3 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="h-5 w-5 sm:-ml-0.5 sm:mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                <span class="hidden sm:inline">New Task</span>
            </button>
            {% elseif showAddButton and canCreateMilestone|default(false) and project is defined and project.milestones|length == 0 %}
            <a href="{{ path('app_milestone_new', {projectId: project.id}) }}"
               class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Milestone First
            </a>
            {% endif %}
        </div>

        {# Table View #}
        <div id="task-view-panel-0" class="task-view-panel">
            {% include 'task/_table_vue.html.twig' with {
                tasks: tasks,
                milestones: milestones|default([]),
                members: projectMembers|default([]),
                canEdit: canEdit|default(false),
                project: project|default(null),
                storageKey: storageKey ~ '_table'
            } %}
        </div>

        {# Kanban View #}
        <div id="task-view-panel-1" class="task-view-panel hidden">
            {% include 'task/_kanban_shared.html.twig' with {
                tasks: tasks,
                milestones: milestones|default([]),
                kanbanModeKey: kanbanModeKey|default('kanban_mode'),
                availableProjects: availableProjects|default([]),
                filteredProjectId: filteredProjectId|default('')
            } %}
        </div>

        {# Gantt View #}
        <div id="task-view-panel-2" class="task-view-panel hidden">
            {% include 'task/_gantt_vue.html.twig' with {
                tasks: tasks,
                milestones: milestones|default([]),
                members: projectMembers|default([]),
                canEdit: canEdit|default(false),
                allStatuses: allStatuses|default([]),
                storageKey: storageKey ~ '_gantt',
                project: project|default(null),
                defaultMilestoneId: currentMilestone is defined and currentMilestone ? currentMilestone.id : ''
            } %}
        </div>
    {% else %}
        {% include 'components/_empty_state.html.twig' with {
            icon: 'task',
            title: filter.hasActiveFilters ? 'No tasks match your filters' : 'No tasks yet',
            description: filter.hasActiveFilters ? 'Try adjusting your filters or clear them to see all tasks.' : 'Tasks will appear here once they are created.'
        } %}
        {% if not filter.hasActiveFilters and showAddButton %}
            <div class="text-center -mt-6 pb-6">
                {% if canCreateTask|default(false) and project is defined and project.milestones|length > 0 %}
                    <button type="button"
                            onclick="openTaskCreatePanel('{{ project.id }}', true, {{ autoAssignNewTasks|default(false) ? 'true' : 'false' }})"
                            class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        Add Task
                    </button>
                {% elseif canCreateMilestone|default(false) and project is defined and project.milestones|length == 0 %}
                    <a href="{{ path('app_milestone_new', {projectId: project.id}) }}"
                       class="inline-flex items-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500">
                        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                        </svg>
                        Add Milestone First
                    </a>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}
</div>

<script>
(function() {
    const container = document.getElementById('task-page-container');
    if (!container) return;

    const storageKey = container.dataset.storageKey;

    const modeSwitcher = document.getElementById('kanban-mode-switcher');

    window.showTaskView = function(index, save = true) {
        // Update view buttons
        document.querySelectorAll('.task-view-btn').forEach((btn, i) => {
            if (i === index) {
                btn.classList.remove('text-gray-600', 'hover:text-gray-900');
                btn.classList.add('bg-white', 'text-primary-600', 'shadow-sm');
            } else {
                btn.classList.remove('bg-white', 'text-primary-600', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:text-gray-900');
            }
        });

        // Update view panels
        document.querySelectorAll('.task-view-panel').forEach((panel, i) => {
            if (i === index) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        });

        // Show/hide kanban mode switcher (only for kanban view, index 1)
        if (modeSwitcher) {
            if (index === 1) {
                modeSwitcher.classList.remove('hidden');
            } else {
                modeSwitcher.classList.add('hidden');
            }
        }

        // Remount Vue components when switching views
        if (typeof window.mountVueComponents === 'function') {
            setTimeout(function() { window.mountVueComponents(); }, 0);
        }

        // Save to localStorage
        if (save && storageKey) {
            try {
                localStorage.setItem(storageKey, index);
            } catch (e) {}
        }
    };

    // Kanban mode switcher
    window.setKanbanMode = function(mode) {
        document.dispatchEvent(new CustomEvent('kanban-set-mode', { detail: { mode } }));
        updateKanbanModeButtons(mode);
    };

    function updateKanbanModeButtons(mode) {
        document.querySelectorAll('.kanban-mode-ext-btn').forEach(btn => {
            if (btn.dataset.mode === mode) {
                btn.classList.remove('text-gray-600', 'hover:text-gray-900');
                btn.classList.add('bg-white', 'text-primary-600', 'shadow-sm');
            } else {
                btn.classList.remove('bg-white', 'text-primary-600', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:text-gray-900');
            }
        });
        const select = document.getElementById('kanban-mode-select');
        if (select) select.value = mode;
    }

    // Listen for mode changes from Vue component (initial load + internal changes)
    document.addEventListener('kanban-mode-changed', function(e) {
        const { mode, hasMilestones } = e.detail || {};
        if (mode) updateKanbanModeButtons(mode);
        if (hasMilestones !== undefined) {
            const milestoneBtn = document.querySelector('.kanban-mode-ext-btn[data-mode="milestone"]');
            const milestoneOpt = document.getElementById('kanban-mode-milestone-option');
            if (milestoneBtn) milestoneBtn.style.display = hasMilestones ? '' : 'none';
            if (milestoneOpt) milestoneOpt.style.display = hasMilestones ? '' : 'none';
        }
    });

    // Restore saved view on load (deferred to ensure DOM is ready and other scripts have run)
    function restoreSavedView() {
        if (!storageKey) return;
        try {
            const savedView = localStorage.getItem(storageKey);
            if (savedView !== null) {
                let viewIndex = parseInt(savedView);
                // 3 views: 0=Table, 1=Kanban, 2=Gantt
                if (viewIndex >= 0 && viewIndex <= 2) {
                    showTaskView(viewIndex, false);
                }
            }
        } catch (e) {}
    }

    // Run after DOM is fully loaded and other scripts have initialized
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            requestAnimationFrame(restoreSavedView);
        });
    } else {
        requestAnimationFrame(restoreSavedView);
    }
})();
</script>

{# Frappe Gantt CSS and JS #}
<link rel="stylesheet" href="{{ asset('vendor/frappe-gantt/frappe-gantt.css') }}">
<script src="{{ asset('vendor/frappe-gantt/frappe-gantt.min.js') }}"></script>
<style>
/* Gantt chart custom styles */
.gantt-view-container {
    min-height: 400px;
}

.gantt-chart-wrapper {
    min-height: 300px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* Mobile optimizations for Gantt chart */
@media (max-width: 767px) {
    .gantt-view-container {
        min-height: 300px;
    }

    .gantt-chart-wrapper {
        min-height: 250px;
    }

    .gantt .bar-label {
        font-size: 10px;
    }

    .gantt .upper-text,
    .gantt .lower-text {
        font-size: 10px;
    }
}

/* Override Frappe Gantt styles to match app theme */
.gantt .bar {
    fill: #059669;
    stroke: #047857;
    stroke-width: 0;
    border-radius: 4px;
}

.gantt .bar-progress {
    fill: #10b981;
}

.gantt .bar-label {
    fill: #fff;
    font-weight: 500;
    font-size: 12px;
}

.gantt .bar-label.big {
    fill: #374151;
}

/* Status-based bar colors */
.gantt .gantt-task-todo .bar {
    fill: #6b7280;
}
.gantt .gantt-task-todo .bar-progress {
    fill: #9ca3af;
}

.gantt .gantt-task-in_progress .bar {
    fill: #3b82f6;
}
.gantt .gantt-task-in_progress .bar-progress {
    fill: #60a5fa;
}

.gantt .gantt-task-in_review .bar {
    fill: #eab308;
}
.gantt .gantt-task-in_review .bar-progress {
    fill: #fbbf24;
}

.gantt .gantt-task-completed .bar {
    fill: #22c55e;
}
.gantt .gantt-task-completed .bar-progress {
    fill: #4ade80;
}

/* Grid styling */
.gantt .grid-header {
    fill: #f9fafb;
    stroke: #e5e7eb;
}

.gantt .grid-row {
    fill: #fff;
}

.gantt .grid-row:nth-child(even) {
    fill: #f9fafb;
}

.gantt .row-line {
    stroke: #e5e7eb;
}

.gantt .tick {
    stroke: #d1d5db;
    stroke-width: 0.2;
}

.gantt .tick.thick {
    stroke-width: 0.4;
}

/* Today marker */
.gantt .today-highlight {
    fill: #dbeafe;
    opacity: 0.5;
}

/* Arrow/dependency lines */
.gantt .arrow {
    fill: none;
    stroke: #9ca3af;
    stroke-width: 1.5;
}

/* Header text */
.gantt .lower-text,
.gantt .upper-text {
    fill: #6b7280;
    font-size: 12px;
}

/* Popup styling */
.gantt-popup {
    z-index: 1000;
}

/* Handle/resize cursor */
.gantt .handle {
    fill: rgba(0, 0, 0, 0.1);
    cursor: ew-resize;
}

.gantt .bar-wrapper:hover .handle {
    fill: rgba(0, 0, 0, 0.2);
}

/* Scrollbar styling */
.gantt-container::-webkit-scrollbar {
    height: 8px;
}

.gantt-container::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.gantt-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.gantt-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
